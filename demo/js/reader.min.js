var EPUBJSR=EPUBJSR||{};EPUBJSR.app={},EPUBJSR.app.init=function(a){"use strict";function b(b){var e=window.location.search.match(/book=(.*)/),b=b||(e?e[1]:"moby-dick");return k=a(window).width(),k>550?a("#main").width(k-m):a("#main").width(k),j=new EPUBJS.Book({bookPath:b,restore:!0}),j.on("book:online",g),j.on("book:offline",h),j.getMetadata().then(c),j.getToc().then(d),j.ready.all.then(f),j.renderTo("area"),a(function(){i()}),j}function c(b){var c=b.bookTitle,d=b.creator,e=a("#book-title"),f=a("#chapter-title"),g=a("#title-seperator");document.title=c+" – "+d,e.html(c),f.html(d),g.show()}function d(b){var c,d,f=a("#toc");f.empty(),d=e(b,1),f.append(d),c=a(".toc_link"),c.on("click",function(b){var c=a(this),d=c.data("url");a(".openChapter").removeClass("openChapter"),c.parents("li").addClass("openChapter"),j.goto(d),b.preventDefault()})}function e(b,c){var d=a("<ul>"),f=1==c?"chapter":"section";return b.forEach(function(b){var g,h=a("<li id='toc-"+b.id+"'>"),i=a("<a class='toc_link "+f+"' href='#/"+b.href+"' data-url='"+b.href+"'>"+b.label+"</a>");h.append(i),b.subitems&&b.subitems.length&&(c++,g=e(b.subitems,c),h.append(g)),d.append(h)}),d}function f(){var b=a("#divider"),c=a("#loader");c.hide(),j.single||b.addClass("show")}function g(){var b=a("#store");l=!1,b.attr("src",b.data("save"))}function h(){var b=a("#store");l=!0,b.attr("src",b.data("saved"))}function i(){function b(){n.addClass("open"),h.addClass("closed"),p.attr("src",p.data("close"))}function c(){i.css("pointer-events","visible"),n.removeClass("open"),h.removeClass("closed"),p.attr("src",p.data("open"))}function d(){t.hide(),s.show()}function e(){s.hide(),t.show()}var f=a("#next"),g=a("#prev"),h=a("#main"),i=a("#area"),n=a("#sidebar"),o=a("#open"),p=o.find("img"),q=a("#network"),r=a("#setting"),s=a("#settingsPanel"),t=a("#toc"),u=a("#fullscreen"),v=a("#fullscreenicon"),w=a("#cancelfullscreenicon"),x=a(window);x.on("resize",function(){k=a(window).width(),k>550?h.width(k-m):h.width(k)}),f.on("click",function(){j.nextPage()}),g.on("click",function(){j.prevPage()}),r.on("click",function(){s.is(":visible")?e():d()}),u.on("click",function(){screenfull.toggle(a("#container")[0]),v.toggle(),w.toggle()});var y=!1;a(document).keydown(function(a){return y?void 0:37==a.keyCode?(g.trigger("click"),y=!0,setTimeout(function(){y=!1},100),!1):39==a.keyCode?(f.trigger("click"),y=!0,setTimeout(function(){y=!1},100),!1):void 0}),o.on("click",function(){n.hasClass("open")?c():b()}),q.on("click",function(){l=!l,j.fromStorage(l)})}var j,k,l=!1,m=0;return b}(jQuery),EPUBJS.reader={},EPUBJS.reader.plugins={},function(a){var b=a.ePubReader||{},c=a.ePubReader=function(a,b){return new EPUBJS.Reader(a,b)};_.extend(c,{noConflict:function(){return a.ePubReader=b,this}}),"function"==typeof define&&define.amd?define(function(){return Reader}):"undefined"!=typeof module&&module.exports&&(module.exports=c)}(window),EPUBJS.Reader=function(a,b){var c=this,d=_.defaults(b||{},{restore:!0}),e=this.book=ePub(a,d);return this.settings=d,this.offline=!1,this.sidebarOpen=!1,e.renderTo("viewer"),c.SettingsView=EPUBJS.reader.SettingsView.call(c,e),c.ControlsView=EPUBJS.reader.ControlsView.call(c,e),e.ready.all.then(function(){c.ReaderView=EPUBJS.reader.ReaderView.call(c,e);for(var a in EPUBJS.reader.plugins)obj.hasOwnProperty(prop)&&a.call(c,e)}),e.getMetadata().then(function(a){c.MetaView=EPUBJS.reader.MetaView.call(c,a)}),e.getToc().then(function(a){c.TocView=EPUBJS.reader.TocView.call(c,a)}),this},EPUBJS.reader.MetaView=function(a){var b=a.bookTitle,c=a.creator,d=$("#book-title"),e=$("#chapter-title"),f=$("#title-seperator");document.title=b+" – "+c,d.html(b),e.html(c),f.show()},EPUBJS.reader.ReaderView=function(a){var b=$("#main"),c=$("#divider"),d=$("#loader"),e=$("#next"),f=$("#prev"),g=function(){b.removeClass("closed")},h=function(){b.addClass("closed")},i=function(){d.show()},j=function(){d.hide()},k=function(){c.addClass("show")},l=function(){c.removeClass("show")},m=!1,n=function(b){37==b.keyCode&&(a.prevPage(),f.addClass("active"),m=!0,setTimeout(function(){m=!1,f.removeClass("active")},100),b.preventDefault()),39==b.keyCode&&(a.nextPage(),e.addClass("active"),m=!0,setTimeout(function(){m=!1,e.removeClass("active")},100),b.preventDefault())};return document.addEventListener("keydown",n,!1),e.on("click",function(b){a.nextPage(),b.preventDefault()}),f.on("click",function(b){a.prevPage(),b.preventDefault()}),j(),a.single||k(),{slideOut:h,slideIn:g,showLoader:i,hideLoader:j,showDivider:k,hideDivider:l}},EPUBJS.reader.ControlsView=function(a){var b=this,c=($("#store"),$("#fullscreen")),d=$("#fullscreenicon"),e=$("#cancelfullscreenicon"),f=$("#slider"),g=($("#main"),$("#sidebar")),h=$("#settings"),i=$("#bookmark"),j=function(){b.offline=!1},k=function(){b.offline=!0},l=function(){b.sidebarOpen=!0,b.ReaderView.slideOut(),g.addClass("open"),f.addClass("icon-right"),f.removeClass("icon-menu")},m=function(){b.sidebarOpen=!1,b.ReaderView.slideIn(),g.removeClass("open"),f.addClass("icon-menu"),f.removeClass("icon-right")};return a.on("book:online",j),a.on("book:offline",k),f.on("click",function(){b.sidebarOpen?m():l()}),c.on("click",function(){screenfull.toggle($("#container")[0]),d.toggle(),e.toggle()}),h.on("click",function(){b.SettingsView.show()}),i.on("click",function(){i.addClass("icon-bookmark"),i.removeClass("icon-bookmark-empty"),console.log(b.book.getCurrentLocationCfi())}),{}},EPUBJS.reader.TocView=function(a){var b=this.book,c=$("#tocView"),d=document.createDocumentFragment(),e=!1,f=function(a,b){var c=document.createElement("ul");return b||(b=1),a.forEach(function(a){var d=document.createElement("li"),e=document.createElement("a");toggle=document.createElement("a");var g;d.id="toc-"+a.id,e.textContent=a.label,e.href=a.href,e.classList.add("toc_link"),d.appendChild(e),a.subitems&&(b++,g=f(a.subitems,b),toggle.classList.add("toc_toggle"),d.insertBefore(toggle,e),d.appendChild(g)),c.appendChild(d)}),c},g=function(){c.show()},h=function(){c.hide()},i=function(a){var b=a.id,d=c.find("#toc-"+b),f=c.find(".currentChapter");c.find(".openChapter"),d.length&&(d!=f&&d.has(e).length>0&&f.removeClass("currentChapter"),d.addClass("currentChapter"),d.parents("li").addClass("openChapter"))};b.on("renderer:chapterDisplayed",i);var j=f(a);return d.appendChild(j),c.append(d),c.find(".toc_link").on("click",function(a){var d=this.getAttribute("href");b.goto(d),c.find(".currentChapter").addClass("openChapter").removeClass("currentChapter"),$(this).parent("li").addClass("currentChapter"),a.preventDefault()}),c.find(".toc_toggle").on("click",function(a){var b=$(this).parent("li"),c=b.hasClass("openChapter");c?b.removeClass("openChapter"):b.addClass("openChapter"),a.preventDefault()}),{show:g,hide:h}},EPUBJS.reader.SettingsView=function(){this.book;var a=$("#settingsPanel"),b=function(){a.show()},c=function(){a.hide()};return{show:b,hide:c}},EPUBJSR.search={},EPUBJSR.search.SERVER="http://localhost:5000",EPUBJSR.search.request=function(a,b){var c=$.ajax({dataType:"json",url:EPUBJSR.search.SERVER+"/search?q="+encodeURIComponent(a)});c.fail(function(a){console.error(a)}),c.done(function(a){b(a)})},EPUBJSR.search.View=function(a){var b,c=$("#searchBox"),d=$("#searchResults"),e=$("#toc"),f=$("#searchView");c.on("search",function(g){var h=c.val();return g.preventDefault(),""==h?(d.empty(),f.removeClass("shown"),e.removeClass("hidden"),$(b).find("body").unhighlight(),b=!1,void 0):(f.hasClass("shown")||(f.addClass("shown"),e.addClass("hidden")),d.empty(),d.append("<li><p>Searching...</p></li>"),EPUBJSR.search.request(h,function(c){var e=c.results;return d.empty(),b&&$(b).find("body").unhighlight(),0==e.length?(d.append("<li><p>No Results Found</p></li>"),void 0):(b=$("#area iframe")[0].contentDocument,$(b).find("body").highlight(h,{element:"span"}),e.forEach(function(c){var e=$("<li></li>"),f=$("<a href='"+c.href+"' data-cfi='"+c.cfi+"'><span>"+c.title+"</span><p>"+c.highlight+"</p></a>");f.on("click",function(c){var d=$(this),e=d.data("cfi");c.preventDefault(),a.gotoCfi(e),a.on("renderer:chapterDisplayed",function(){b=$("#area iframe")[0].contentDocument,$(b).find("body").highlight(h,{element:"span"})})}),e.append(f),d.append(e)}),void 0)}),void 0)})},jQuery.fn.extend({clickOutside:function(a,b){var c=this;return jQuery(document).on("click.offer",function(d){b&&jQuery.inArray(d.target,b)>-1||jQuery.contains(c[0],d.target)||(jQuery(document).off("click.offer"),a(d,c))}),this}});