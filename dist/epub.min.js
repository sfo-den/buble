"undefined"==typeof EPUBJS&&(("undefined"!=typeof window?window:this).EPUBJS={}),EPUBJS.VERSION="0.3.0",EPUBJS.Render={},function(t){"use strict";var e=function(t){return new EPUBJS.Book(t)};e.Render={register:function(t,i){e.Render[t]=i}},"object"==typeof exports?(t.RSVP=require("rsvp"),module.exports=e):"function"==typeof define&&define.amd?define(e):t.ePub=e}(this),function(){"use strict";function t(t,e){for(var i=0,n=t.length;n>i;i++)if(t[i]===e)return i;return-1}function e(t){var e=t._promiseCallbacks;return e||(e=t._promiseCallbacks={}),e}function i(t,e){return"onerror"===t?(Y.on("error",e),void 0):2!==arguments.length?Y[t]:(Y[t]=e,void 0)}function n(t){return"function"==typeof t||"object"==typeof t&&null!==t}function r(t){return"function"==typeof t}function o(t){return"object"==typeof t&&null!==t}function s(){}function h(){}function a(t){try{return t.then}catch(e){return oe.error=e,oe}}function c(t,e,i,n){try{t.call(e,i,n)}catch(r){return r}}function p(t,e,i){Y.async(function(t){var n=!1,r=c(i,e,function(i){n||(n=!0,e!==i?u(t,i):g(t,i))},function(e){n||(n=!0,y(t,e))},"Settle: "+(t._label||" unknown promise"));!n&&r&&(n=!0,y(t,r))},t)}function l(t,e){e._state===ne?g(t,e._result):t._state===re?y(t,e._result):m(e,void 0,function(i){e!==i?u(t,i):g(t,i)},function(e){y(t,e)})}function d(t,e){if(e.constructor===t.constructor)l(t,e);else{var i=a(e);i===oe?y(t,oe.error):void 0===i?g(t,e):r(i)?p(t,e,i):g(t,e)}}function u(t,e){t===e?g(t,e):n(e)?d(t,e):g(t,e)}function f(t){t._onerror&&t._onerror(t._result),v(t)}function g(t,e){t._state===ie&&(t._result=e,t._state=ne,0===t._subscribers.length?Y.instrument&&ee("fulfilled",t):Y.async(v,t))}function y(t,e){t._state===ie&&(t._state=re,t._result=e,Y.async(f,t))}function m(t,e,i,n){var r=t._subscribers,o=r.length;t._onerror=null,r[o]=e,r[o+ne]=i,r[o+re]=n,0===o&&t._state&&Y.async(v,t)}function v(t){var e=t._subscribers,i=t._state;if(Y.instrument&&ee(i===ne?"fulfilled":"rejected",t),0!==e.length){for(var n,r,o=t._result,s=0;s<e.length;s+=3)n=e[s],r=e[s+i],n?E(i,n,r,o):r(o);t._subscribers.length=0}}function w(){this.error=null}function S(t,e){try{return t(e)}catch(i){return se.error=i,se}}function E(t,e,i,n){var o,s,h,a,c=r(i);if(c){if(o=S(i,n),o===se?(a=!0,s=o.error,o=null):h=!0,e===o)return y(e,new TypeError("A promises callback cannot return that same promise.")),void 0}else o=n,h=!0;e._state!==ie||(c&&h?u(e,o):a?y(e,s):t===ne?g(e,o):t===re&&y(e,o))}function P(t,e){try{e(function(e){u(t,e)},function(e){y(t,e)})}catch(i){y(t,i)}}function B(t,e,i){return t===ne?{state:"fulfilled",value:i}:{state:"rejected",reason:i}}function b(t,e,i,n){this._instanceConstructor=t,this.promise=new t(h,n),this._abortOnReject=i,this._validateInput(e)?(this._input=e,this.length=e.length,this._remaining=e.length,this._init(),0===this.length?g(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&g(this.promise,this._result))):y(this.promise,this._validationError())}function U(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function J(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function x(t,e){this._id=ue++,this._label=e,this._state=void 0,this._result=void 0,this._subscribers=[],Y.instrument&&ee("created",this),h!==t&&(r(t)||U(),this instanceof x||J(),P(this,t))}function R(){this.value=void 0}function C(t){try{return t.then}catch(e){return ge.value=e,ge}}function k(t,e,i){try{t.apply(e,i)}catch(n){return ge.value=n,ge}}function _(t,e){for(var i,n,r={},o=t.length,s=new Array(o),h=0;o>h;h++)s[h]=t[h];for(n=0;n<e.length;n++)i=e[n],r[i]=s[n+1];return r}function T(t){for(var e=t.length,i=new Array(e-1),n=1;e>n;n++)i[n-1]=t[n];return i}function F(t,e){return{then:function(i,n){return t.call(e,i,n)}}}function I(t,e,i,n){var r=k(i,n,e);return r===ge&&y(t,r.value),t}function N(t,e,i,n){return fe.all(e).then(function(e){var r=k(i,n,e);return r===ge&&y(t,r.value),t})}function V(t){return t&&"object"==typeof t?t.constructor===fe?!0:C(t):!1}function A(t,e,i){this._superConstructor(t,e,!1,i)}function O(t,e,i){this._superConstructor(t,e,!0,i)}function L(t,e,i){this._superConstructor(t,e,!1,i)}function q(){return function(){process.nextTick(H)}}function z(){var t=0,e=new Ie(H),i=document.createTextNode("");return e.observe(i,{characterData:!0}),function(){i.data=t=++t%2}}function M(){var t=new MessageChannel;return t.port1.onmessage=H,function(){t.port2.postMessage(0)}}function j(){return function(){setTimeout(H,1)}}function H(){for(var t=0;_e>t;t+=2){var e=Ve[t],i=Ve[t+1];e(i),Ve[t]=void 0,Ve[t+1]=void 0}_e=0}function W(t,e){Y.async(t,e)}function D(){Y.on.apply(Y,arguments)}function X(){Y.off.apply(Y,arguments)}var K={mixin:function(t){return t.on=this.on,t.off=this.off,t.trigger=this.trigger,t._promiseCallbacks=void 0,t},on:function(i,n){var r,o=e(this);r=o[i],r||(r=o[i]=[]),-1===t(r,n)&&r.push(n)},off:function(i,n){var r,o,s=e(this);return n?(r=s[i],o=t(r,n),-1!==o&&r.splice(o,1),void 0):(s[i]=[],void 0)},trigger:function(t,i){var n,r,o=e(this);if(n=o[t])for(var s=0;s<n.length;s++)r=n[s],r(i)}},Y={instrument:!1};K.mixin(Y);var G;G=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};var Q=G,Z=Date.now||function(){return(new Date).getTime()},$=Object.create||function(t){if(arguments.length>1)throw new Error("Second argument not supported");if("object"!=typeof t)throw new TypeError("Argument must be an object");return s.prototype=t,new s},te=[],ee=function(t,e,i){1===te.push({name:t,payload:{guid:e._guidKey+e._id,eventName:t,detail:e._result,childGuid:i&&e._guidKey+i._id,label:e._label,timeStamp:Z(),stack:new Error(e._label).stack}})&&setTimeout(function(){for(var t,e=0;e<te.length;e++)t=te[e],Y.trigger(t.name,t.payload);te.length=0},50)},ie=void 0,ne=1,re=2,oe=new w,se=new w;b.prototype._validateInput=function(t){return Q(t)},b.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")},b.prototype._init=function(){this._result=new Array(this.length)};var he=b;b.prototype._enumerate=function(){for(var t=this.length,e=this.promise,i=this._input,n=0;e._state===ie&&t>n;n++)this._eachEntry(i[n],n)},b.prototype._eachEntry=function(t,e){var i=this._instanceConstructor;o(t)?t.constructor===i&&t._state!==ie?(t._onerror=null,this._settledAt(t._state,e,t._result)):this._willSettleAt(i.resolve(t),e):(this._remaining--,this._result[e]=this._makeResult(ne,e,t))},b.prototype._settledAt=function(t,e,i){var n=this.promise;n._state===ie&&(this._remaining--,this._abortOnReject&&t===re?y(n,i):this._result[e]=this._makeResult(t,e,i)),0===this._remaining&&g(n,this._result)},b.prototype._makeResult=function(t,e,i){return i},b.prototype._willSettleAt=function(t,e){var i=this;m(t,void 0,function(t){i._settledAt(ne,e,t)},function(t){i._settledAt(re,e,t)})};var ae=function(t,e){return new he(this,t,!0,e).promise},ce=function(t,e){function i(t){u(o,t)}function n(t){y(o,t)}var r=this,o=new r(h,e);if(!Q(t))return y(o,new TypeError("You must pass an array to race.")),o;for(var s=t.length,a=0;o._state===ie&&s>a;a++)m(r.resolve(t[a]),void 0,i,n);return o},pe=function(t,e){var i=this;if(t&&"object"==typeof t&&t.constructor===i)return t;var n=new i(h,e);return u(n,t),n},le=function(t,e){var i=this,n=new i(h,e);return y(n,t),n},de="rsvp_"+Z()+"-",ue=0,fe=x;x.cast=pe,x.all=ae,x.race=ce,x.resolve=pe,x.reject=le,x.prototype={constructor:x,_guidKey:de,_onerror:function(t){Y.trigger("error",t)},then:function(t,e,i){var n=this,r=n._state;if(r===ne&&!t||r===re&&!e)return Y.instrument&&ee("chained",this,this),this;n._onerror=null;var o=new this.constructor(h,i),s=n._result;if(Y.instrument&&ee("chained",n,o),r){var a=arguments[r-1];Y.async(function(){E(r,o,a,s)})}else m(n,o,t,e);return o},"catch":function(t,e){return this.then(null,t,e)},"finally":function(t,e){var i=this.constructor;return this.then(function(e){return i.resolve(t()).then(function(){return e})},function(e){return i.resolve(t()).then(function(){throw e})},e)}};var ge=new R,ye=new R,me=function(t,e){var i=function(){for(var i,n=this,r=arguments.length,o=new Array(r+1),s=!1,a=0;r>a;++a){if(i=arguments[a],!s){if(s=V(i),s===ye){var c=new fe(h);return y(c,ye.value),c}s&&s!==!0&&(i=F(s,i))}o[a]=i}var p=new fe(h);return o[r]=function(t,i){t?y(p,t):void 0===e?u(p,i):e===!0?u(p,T(arguments)):Q(e)?u(p,_(arguments,e)):u(p,i)},s?N(p,o,t,n):I(p,o,t,n)};return i.__proto__=t,i},ve=function(t,e){return fe.all(t,e)};A.prototype=$(he.prototype),A.prototype._superConstructor=he,A.prototype._makeResult=B,A.prototype._validationError=function(){return new Error("allSettled must be called with an array")};var we=function(t,e){return new A(fe,t,e).promise},Se=function(t,e){return fe.race(t,e)},Ee=O;O.prototype=$(he.prototype),O.prototype._superConstructor=he,O.prototype._init=function(){this._result={}},O.prototype._validateInput=function(t){return t&&"object"==typeof t},O.prototype._validationError=function(){return new Error("Promise.hash must be called with an object")},O.prototype._enumerate=function(){var t=this.promise,e=this._input,i=[];for(var n in e)t._state===ie&&e.hasOwnProperty(n)&&i.push({position:n,entry:e[n]});var r=i.length;this._remaining=r;for(var o,s=0;t._state===ie&&r>s;s++)o=i[s],this._eachEntry(o.entry,o.position)};var Pe=function(t,e){return new Ee(fe,t,e).promise};L.prototype=$(Ee.prototype),L.prototype._superConstructor=he,L.prototype._makeResult=B,L.prototype._validationError=function(){return new Error("hashSettled must be called with an object")};var Be,be=function(t,e){return new L(fe,t,e).promise},Ue=function(t){throw setTimeout(function(){throw t}),t},Je=function(t){var e={};return e.promise=new fe(function(t,i){e.resolve=t,e.reject=i},t),e},xe=function(t,e,i){return fe.all(t,i).then(function(t){if(!r(e))throw new TypeError("You must pass a function as map's second argument.");for(var n=t.length,o=new Array(n),s=0;n>s;s++)o[s]=e(t[s]);return fe.all(o,i)})},Re=function(t,e){return fe.resolve(t,e)},Ce=function(t,e){return fe.reject(t,e)},ke=function(t,e,i){return fe.all(t,i).then(function(t){if(!r(e))throw new TypeError("You must pass a function as filter's second argument.");for(var n=t.length,o=new Array(n),s=0;n>s;s++)o[s]=e(t[s]);return fe.all(o,i).then(function(e){for(var i=new Array(n),r=0,o=0;n>o;o++)e[o]&&(i[r]=t[o],r++);return i.length=r,i})})},_e=0,Te=function(t,e){Ve[_e]=t,Ve[_e+1]=e,_e+=2,2===_e&&Be()},Fe="undefined"!=typeof window?window:{},Ie=Fe.MutationObserver||Fe.WebKitMutationObserver,Ne="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,Ve=new Array(1e3);Be="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?q():Ie?z():Ne?M():j(),Y.async=Te;if("undefined"!=typeof window&&"object"==typeof window.__PROMISE_INSTRUMENTATION__){var Ae=window.__PROMISE_INSTRUMENTATION__;i("instrument",!0);for(var Oe in Ae)Ae.hasOwnProperty(Oe)&&D(Oe,Ae[Oe])}var Le={race:Se,Promise:fe,allSettled:we,hash:Pe,hashSettled:be,denodeify:me,on:D,off:X,map:xe,filter:ke,resolve:Re,reject:Ce,all:ve,rethrow:Ue,defer:Je,EventTarget:K,configure:i,async:W};"function"==typeof define&&define.amd?define(function(){return Le}):"undefined"!=typeof module&&module.exports?module.exports=Le:"undefined"!=typeof this&&(this.RSVP=Le)}.call(this),EPUBJS.Book=function(t){this.opening=new RSVP.defer,this.opened=this.opening.promise,this.isOpen=!1,this.url=void 0,this.spine=new EPUBJS.Spine(this.request),this.loading={manifest:new RSVP.defer,spine:new RSVP.defer,metadata:new RSVP.defer,cover:new RSVP.defer,navigation:new RSVP.defer,pageList:new RSVP.defer},this.loaded={manifest:this.loading.manifest.promise,spine:this.loading.spine.promise,metadata:this.loading.metadata.promise,cover:this.loading.cover.promise,navigation:this.loading.navigation.promise,pageList:this.loading.pageList.promise},this.ready=RSVP.hash(this.loaded),this.isRendered=!1,this._q=EPUBJS.core.queue(this),this.request=this.requestMethod.bind(this),t&&this.open(t)},EPUBJS.Book.prototype.open=function(t){var e,i,n,r=new EPUBJS.Parser,o=this,s="META-INF/container.xml";return t?(e="object"==typeof t?t:EPUBJS.core.uri(t),"opf"===e.extension?(this.packageUrl=e.href,this.containerUrl="",e.origin?this.url=e.base:window?(n=EPUBJS.core.uri(window.location.href),this.url=EPUBJS.core.resolveUrl(n.base,e.directory)):this.url=e.directory,i=this.request(this.packageUrl)):"epub"===e.extension||"zip"===e.extension?(this.archived=!0,this.url=""):e.extension||(this.containerUrl=t+s,i=this.request(this.containerUrl).then(function(t){return r.container(t)}).then(function(e){var i=EPUBJS.core.uri(e.packagePath);return o.packageUrl=t+e.packagePath,o.url=t+i.directory,o.encoding=e.encoding,o.request(o.packageUrl)}).catch(function(t){console.error("Could not load book at: "+(this.packageUrl||this.containerPath)),o.trigger("book:loadFailed",this.packageUrl||this.containerPath),o.opening.reject(t)})),i.then(function(t){o.unpack(t),o.loading.manifest.resolve(o.package.manifest),o.loading.metadata.resolve(o.package.metadata),o.loading.spine.resolve(o.spine),o.loading.cover.resolve(o.cover),this.isOpen=!0,o.opening.resolve(o)}).catch(function(t){console.error(t.message,t.stack),o.opening.reject(t)}),this.opened):(this.opening.resolve(this),this.opened)},EPUBJS.Book.prototype.unpack=function(t){var e=this,i=new EPUBJS.Parser;e.package=i.packageContents(t),e.package.baseUrl=e.url,this.spine.load(e.package),e.navigation=new EPUBJS.Navigation(e.package,this.request),e.navigation.load().then(function(t){e.toc=t,e.loading.navigation.resolve(e.toc)}),e.cover=e.url+e.package.coverPath},EPUBJS.Book.prototype.section=function(t){return this.spine.get(t)},EPUBJS.Book.prototype.renderTo=function(t,e){return this.rendition=new EPUBJS.Rendition(this,e),this.rendition.attachTo(t),this.rendition},EPUBJS.Book.prototype.requestMethod=function(t){return this.archived?void 0:EPUBJS.core.request(t,"xml",this.requestCredentials,this.requestHeaders)},EPUBJS.Book.prototype.setRequestCredentials=function(t){this.requestCredentials=t},EPUBJS.Book.prototype.setRequestHeaders=function(t){this.requestHeaders=t},RSVP.EventTarget.mixin(EPUBJS.Book.prototype),RSVP.on("error",function(){}),RSVP.configure("instrument",!0),RSVP.on("rejected",function(t){console.error(t.detail.message,t.detail.stack)}),EPUBJS.Continuous=function(){this.views=[],this.container=container,this.limit=limit||4},EPUBJS.Continuous.prototype.append=function(t){this.views.push(t),this.container.appendChild(t.element()),t.onDisplayed=function(){var t,e=this.views.indexOf(t),i=t.section.next();e+1===this.views.length&&i&&(t=new EPUBJS.View(i),this.append(t))}.bind(this),this.resizeView(t)},EPUBJS.Continuous.prototype.prepend=function(t){this.views.unshift(t),this.container.insertBefore(t.element,this.container.firstChild),t.onDisplayed=function(){var t,e=(this.views.indexOf(t),t.section.prev());e&&(t=new EPUBJS.View(e),this.append(t))}.bind(this),this.resizeView(t)},EPUBJS.Continuous.prototype.fill=function(t){this.views.length&&this.clear(),this.views.push(t),this.container.appendChild(t.element),t.onDisplayed=function(){var e,i,n=t.section.next(),r=t.section.prev(),o=this.views.indexOf(t);o+1===this.views.length&&n&&(e=new EPUBJS.View(n),this.append(e)),0===o&&r&&(i=new EPUBJS.View(r),this.append(i)),this.resizeView(t)}.bind(this)},EPUBJS.Continuous.prototype.insert=function(t,e){this.views.splice(e,0,t),e<this.cotainer.children.length?this.container.insertBefore(t.element(),this.container.children[e]):this.container.appendChild(t.element())},EPUBJS.Continuous.prototype.remove=function(t){var e=this.views.indexOf(t);t.destroy(),e>-1&&this.views.splice(e,1)},EPUBJS.Continuous.prototype.clear=function(){this.views.forEach(function(t){t.destroy()}),this.views=[]},EPUBJS.Continuous.prototype.first=function(){return this.views[0]},EPUBJS.Continuous.prototype.last=function(){return this.views[this.views.length-1]},EPUBJS.Continuous.prototype.each=function(t){return this.views.forEach(t)},EPUBJS.Continuous.prototype.check=function(){{var t=this.container.getBoundingClientRect();(function(e){var i=e.bounds();i.bottom>=t.top&&!(i.top>t.bottom)&&i.right>=t.left&&!(i.left>t.right)?(console.log("visible",e.index),this.resizeView(e),this.display(e)):(console.log("off screen",e.index),e.destroy())}).bind(this)}this.views.forEach(this.isVisible)},EPUBJS.Continuous.prototype.displayView=function(t){return t.display(this.book.request).then(function(){return this.hooks.display.trigger(t)}.bind(this)).then(function(){return this.hooks.replacements.trigger(t,this)}.bind(this)).then(function(){return t.expand()}.bind(this)).then(function(){return this.rendering=!1,t.show(),this.trigger("rendered",section),t}.bind(this)).catch(function(t){this.trigger("loaderror",t)}.bind(this))},EPUBJS.Continuous.prototype.resizeView=function(t){var e=this.container.getBoundingClientRect(),i=window.getComputedStyle(this.container),n={left:parseFloat(i["padding-left"])||0,right:parseFloat(i["padding-right"])||0,top:parseFloat(i["padding-top"])||0,bottom:parseFloat(i["padding-bottom"])||0},r=e.width-n.left-n.right,o=e.height-n.top-n.bottom,s=100,h=200;"vertical"===this.settings.axis?t.resize(r,s):t.resize(h,o)},EPUBJS.core={},EPUBJS.core.request=function(t,e,i,n){function r(){if(this.readyState===this.DONE)if(200===this.status||this.responseXML){var t;t="xml"==e?this.responseXML?this.responseXML:(new DOMParser).parseFromString(this.response,"text/xml"):"json"==e?JSON.parse(this.response):"blob"==e?s?this.response:new Blob([this.response]):this.response,a.resolve(t)}else a.reject({status:this.status,message:this.response,stack:(new Error).stack})}var o,s=window.URL,h=s?"blob":"arraybuffer",a=new RSVP.defer,c=new XMLHttpRequest,p=XMLHttpRequest.prototype;"overrideMimeType"in p||Object.defineProperty(p,"overrideMimeType",{value:function(){}}),i&&(c.withCredentials=!0),c.open("GET",t,!0);for(o in n)c.setRequestHeader(o,n[o]);return c.onreadystatechange=r,"blob"==e&&(c.responseType=h),"json"==e&&c.setRequestHeader("Accept","application/json"),"xml"==e&&c.overrideMimeType("text/xml"),c.send(),a.promise},EPUBJS.core.uri=function(t){var e,i,n,r={protocol:"",host:"",path:"",origin:"",directory:"",base:"",filename:"",extension:"",fragment:"",href:t},o=t.indexOf("://"),s=t.indexOf("?"),h=t.indexOf("#");return-1!=h&&(r.fragment=t.slice(h+1),t=t.slice(0,h)),-1!=s&&(r.search=t.slice(s+1),t=t.slice(0,s),href=t),-1!=o?(r.protocol=t.slice(0,o),e=t.slice(o+3),n=e.indexOf("/"),-1===n?(r.host=r.path,r.path=""):(r.host=e.slice(0,n),r.path=e.slice(n)),r.origin=r.protocol+"://"+r.host,r.directory=EPUBJS.core.folder(r.path),r.base=r.origin+r.directory):(r.path=t,r.directory=EPUBJS.core.folder(t),r.base=r.directory),r.filename=t.replace(r.base,""),i=r.filename.lastIndexOf("."),-1!=i&&(r.extension=r.filename.slice(i+1)),r},EPUBJS.core.folder=function(t){var e=t.lastIndexOf("/");if(-1==e)var i="";return i=t.slice(0,e+1)},EPUBJS.core.queue=function(t){var e=[],i=t,n=function(t,i,n){return e.push({funcName:t,args:i,context:n}),e},r=function(){var t;e.length&&(t=e.shift(),i[t.funcName].apply(t.context||i,t.args))},o=function(){for(;e.length;)r()},s=function(){e=[]},h=function(){return e.length};return{enqueue:n,dequeue:r,flush:o,clear:s,length:h}},EPUBJS.core.isElement=function(t){return!(!t||1!=t.nodeType)},EPUBJS.core.uuid=function(){var t=(new Date).getTime(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?i:7&i|8).toString(16)});return e},EPUBJS.core.values=function(t){for(var e=-1,i=Object.keys(t),n=i.length,r=Array(n);++e<n;)r[e]=t[i[e]];return r},EPUBJS.core.resolveUrl=function(t,e){var i,n=[],r=[],o=EPUBJS.core.uri(t),s=EPUBJS.core.uri(e),h=o.directory,a=s.directory,c=[];return"/"===h[0]&&(h=h.substring(1)),"/"===a[a.length-1]&&(h=h.substring(0,h.length-1)),"/"===a[0]&&(a=a.substring(1)),"/"===a[a.length-1]&&(a=a.substring(0,a.length-1)),h&&(c=h.split("/")),i=a.split("/"),i.reverse().forEach(function(t){".."===t?c.pop():t===c[c.length-1]?(c.pop(),r.unshift(t)):r.unshift(t)}),n=[o.origin],c.length&&(n=n.concat(c)),r&&(n=n.concat(r)),n=n.concat(s.filename),n.join("/")},EPUBJS.core.documentHeight=function(){return Math.max(document.documentElement.clientHeight,document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight)},EPUBJS.core.isNumber=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},EPUBJS.core.prefixed=function(t){var e=["Webkit","Moz","O","ms"],i=t[0].toUpperCase()+t.slice(1),n=e.length;if("undefined"!=typeof document.body.style[t])return t;for(var r=0;n>r;r++)if("undefined"!=typeof document.body.style[e[r]+i])return e[r]+i;return t},EPUBJS.core.defaults=function(t){for(var e=1,i=arguments.length;i>e;e++){var n=arguments[e];for(var r in n)void 0===t[r]&&(t[r]=n[r])}return t},EPUBJS.core.insert=function(t,e,i){var n=EPUBJS.core.locationOf(t,e,i);return e.splice(n,0,t),n},EPUBJS.core.locationOf=function(t,e,i,n,r){var o,s=n||0,h=r||e.length,a=parseInt(s+(h-s)/2);return i||(i=function(t,e){return t>e?1:e>t?-1:(t=e)?0:void 0}),0>=h-s?a:(o=i(e[a],t),h-s===1?o>0?a:a+1:0===o?a:-1===o?EPUBJS.core.locationOf(t,e,i,a,h):EPUBJS.core.locationOf(t,e,i,s,a))},EPUBJS.core.indexOfSorted=function(t,e,i,n,r){var o,s=n||0,h=r||e.length,a=parseInt(s+(h-s)/2);return i||(i=function(t,e){return t>e?1:e>t?-1:(t=e)?0:void 0}),0>=h-s?-1:(o=i(e[a],t),h-s===1?0===o?a:-1:0===o?a:-1===o?EPUBJS.core.indexOfSorted(t,e,i,a,h):EPUBJS.core.indexOfSorted(t,e,i,s,a))},EPUBJS.EpubCFI=function(t){return t?this.parse(t):void 0},EPUBJS.EpubCFI.prototype.generateChapterComponent=function(t,e,i){var n=parseInt(e),r=t+1,o="/"+r+"/";return o+=2*(n+1),i&&(o+="["+i+"]"),o},EPUBJS.EpubCFI.prototype.generatePathComponent=function(t){var e=[];return t.forEach(function(t){var i="";i+=2*(t.index+1),t.id&&(i+="["+t.id+"]"),e.push(i)}),e.join("/")},EPUBJS.EpubCFI.prototype.generateCfiFromElement=function(t,e){var i=this.pathTo(t),n=this.generatePathComponent(i);return n.length?"epubcfi("+e+"!"+n+"/1:0)":"epubcfi("+e+"!/4/)"},EPUBJS.EpubCFI.prototype.pathTo=function(t){for(var e,i=[];t&&null!==t.parentNode&&9!=t.parentNode.nodeType;)e=t.parentNode.children,i.unshift({id:t.id,tagName:t.tagName,index:e?Array.prototype.indexOf.call(e,t):0}),t=t.parentNode;return i},EPUBJS.EpubCFI.prototype.getChapterComponent=function(t){var e=t.split("!");return e[0]},EPUBJS.EpubCFI.prototype.getPathComponent=function(t){var e=t.split("!"),i=e[1]?e[1].split(":"):"";return i[0]},EPUBJS.EpubCFI.prototype.getCharecterOffsetComponent=function(t){var e=t.split(":");return e[1]||""},EPUBJS.EpubCFI.prototype.parse=function(t){var e,i,n,r,o,s,h,a,c,p={},l=function(t){var e,i,n,r;return e="element",i=parseInt(t)/2-1,n=t.match(/\[(.*)\]/),n&&n[1]&&(r=n[1]),{type:e,index:i,id:r||!1}};return"string"!=typeof t?{spinePos:-1}:(p.str=t,0===t.indexOf("epubcfi(")&&")"===t[t.length-1]&&(t=t.slice(8,t.length-1)),i=this.getChapterComponent(t),n=this.getPathComponent(t)||"",r=this.getCharecterOffsetComponent(t),i?(e=i.split("/")[2]||"")?(p.spinePos=parseInt(e)/2-1||0,s=e.match(/\[(.*)\]/),p.spineId=s?s[1]:!1,-1!=n.indexOf(",")&&console.warn("CFI Ranges are not supported"),h=n.split("/"),a=h.pop(),p.steps=[],h.forEach(function(t){var e;t&&(e=l(t),p.steps.push(e))}),c=parseInt(a),isNaN(c)||(c%2===0?p.steps.push(l(a)):p.steps.push({type:"text",index:(c-1)/2})),o=r.match(/\[(.*)\]/),o&&o[1]?(p.characterOffset=parseInt(r.split("[")[0]),p.textLocationAssertion=o[1]):p.characterOffset=parseInt(r),p):{spinePos:-1}:{spinePos:-1})},EPUBJS.EpubCFI.prototype.addMarker=function(t,e,i){var n,r,o,s,h=e||document,a=i||this.createMarker(h);return"string"==typeof t&&(t=this.parse(t)),r=t.steps[t.steps.length-1],-1===t.spinePos?!1:(n=this.findParent(t,h))?(r&&"text"===r.type?(o=n.childNodes[r.index],t.characterOffset?(s=o.splitText(t.characterOffset),a.classList.add("EPUBJS-CFI-SPLIT"),n.insertBefore(a,s)):n.insertBefore(a,o)):n.insertBefore(a,n.firstChild),a):!1},EPUBJS.EpubCFI.prototype.createMarker=function(t){var e=t||document,i=e.createElement("span");return i.id="EPUBJS-CFI-MARKER:"+EPUBJS.core.uuid(),i.classList.add("EPUBJS-CFI-MARKER"),i},EPUBJS.EpubCFI.prototype.removeMarker=function(t,e){t.classList.contains("EPUBJS-CFI-SPLIT")?(nextSib=t.nextSibling,prevSib=t.previousSibling,nextSib&&prevSib&&3===nextSib.nodeType&&3===prevSib.nodeType&&(prevSib.textContent+=nextSib.textContent,t.parentNode.removeChild(nextSib)),t.parentNode.removeChild(t)):t.classList.contains("EPUBJS-CFI-MARKER")&&t.parentNode.removeChild(t)},EPUBJS.EpubCFI.prototype.findParent=function(t,e){var i,n,r,o=e||document,s=o.getElementsByTagName("html")[0],h=Array.prototype.slice.call(s.children);if("string"==typeof t&&(t=this.parse(t)),n=t.steps.slice(0),!n.length)return o.getElementsByTagName("body")[0];for(;n&&n.length>0;){if(i=n.shift(),"text"===i.type?(r=s.childNodes[i.index],s=r.parentNode||s):s=i.id?o.getElementById(i.id):h[i.index],"undefined"==typeof s)return console.error("No Element For",i,t.str),!1;h=Array.prototype.slice.call(s.children)}return s},EPUBJS.EpubCFI.prototype.compare=function(t,e){if("string"==typeof t&&(t=new EPUBJS.EpubCFI(t)),"string"==typeof e&&(e=new EPUBJS.EpubCFI(e)),t.spinePos>e.spinePos)return 1;if(t.spinePos<e.spinePos)return-1;for(var i=0;i<t.steps.length;i++){if(!e.steps[i])return 1;if(t.steps[i].index>e.steps[i].index)return 1;if(t.steps[i].index<e.steps[i].index)return-1}return t.steps.length<e.steps.length?-1:t.characterOffset>e.characterOffset?1:t.characterOffset<e.characterOffset?-1:0},EPUBJS.EpubCFI.prototype.generateCfiFromHref=function(t,e){var i,n,r=EPUBJS.core.uri(t),o=r.path,s=r.fragment,h=e.spineIndexByURL[o],a=new RSVP.defer,c=new EPUBJS.EpubCFI;return"undefined"!=typeof h&&(n=e.spine[h],i=e.loadXml(n.url),i.then(function(t){var e,i=t.getElementById(s);e=c.generateCfiFromElement(i,n.cfiBase),a.resolve(e)})),a.promise},EPUBJS.EpubCFI.prototype.generateCfiFromTextNode=function(t,e,i){var n=t.parentNode,r=this.pathTo(n),o=this.generatePathComponent(r),s=1+2*Array.prototype.indexOf.call(n.childNodes,t);return"epubcfi("+i+"!"+o+"/"+s+":"+(e||0)+")"},EPUBJS.EpubCFI.prototype.generateCfiFromRangeAnchor=function(t,e){var i=t.anchorNode,n=t.anchorOffset;return this.generateCfiFromTextNode(i,n,e)},EPUBJS.EpubCFI.prototype.generateCfiFromRange=function(t,e){var i,n,r,o,s,h,a,c,p,l,d,u;if(i=t.startContainer,3===i.nodeType)n=i.parentNode,h=1+2*EPUBJS.core.indexOfTextNode(i),r=this.pathTo(n);else{if(t.collapsed)return this.generateCfiFromElement(i,e);r=this.pathTo(i)}return o=this.generatePathComponent(r),s=t.startOffset,t.collapsed?"epubcfi("+e+"!"+o+"/"+h+":"+s+")":(a=t.endContainer,3===a.nodeType?(c=a.parentNode,u=1+2*EPUBJS.core.indexOfTextNode(a),p=this.pathTo(c)):p=this.pathTo(a),l=this.generatePathComponent(p),d=t.endOffset,"epubcfi("+e+"!"+o+"/"+h+":"+s+","+l+"/"+u+":"+d+")")},EPUBJS.EpubCFI.prototype.generateXpathFromSteps=function(t){var e=[".","*"];return t.forEach(function(t){var i=t.index+1;t.id?e.push("*[position()="+i+" and @id='"+t.id+"']"):"text"===t.type?e.push("text()["+i+"]"):e.push("*["+i+"]")}),e.join("/")},EPUBJS.EpubCFI.prototype.generateRangeFromCfi=function(t,e){var i,n,r,o,s=e||document,h=s.createRange();return"string"==typeof t&&(t=this.parse(t)),-1===t.spinePos?!1:(n=this.generateXpathFromSteps(t.steps),i=t.steps[t.steps.length-1],(r=s.evaluate(n,s,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue)?(r&&t.characterOffset>=0?(o=r.length,t.characterOffset<o?(h.setStart(r,t.characterOffset),h.setEnd(r,o)):(console.debug("offset greater than length:",t.characterOffset,o),h.setStart(r,o-1),h.setEnd(r,o))):r&&h.selectNode(r),h):null)},EPUBJS.Hook=function(t){this.context=t||this,this.hooks=[]},EPUBJS.Hook.prototype.register=function(t){this.hooks.push(t)},EPUBJS.Hook.prototype.trigger=function(){var t,e=this.hooks.length,i=0,n=new RSVP.defer,r=arguments;return e?(t=this.hooks[i].apply(this.context,r),t.then(function(){return i+=1,e>i?this.hooks[i].apply(this.context,r):void 0}.bind(this))):(t=n.promise,n.resolve()),t},EPUBJS.Infinite=function(t,e){this.container=t,this.windowHeight=window.innerHeight,this.tick=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,this.scrolled=!1,this.ignore=!1,this.displaying=!1,this.offset=500,this.views=[],this.axis=e,this.prevScrollTop=0},EPUBJS.Infinite.prototype.start=function(){this.container.addEventListener("scroll",function(){this.ignore?this.ignore=!1:this.scrolled=!0}.bind(this)),window.addEventListener("unload",function(){this.ignore=!0}),this.tick.call(window,this.check.bind(this)),this.scrolled=!1},EPUBJS.Infinite.prototype.forwards=function(){this.trigger("forwards")},EPUBJS.Infinite.prototype.backwards=function(){this.trigger("backwards")},EPUBJS.Infinite.prototype.check=function(){this.scrolled&&!this.displaying?("vertical"===this.axis?this.checkTop():this.checkLeft(),this.trigger("scroll",{top:this.container.scrollTop,left:this.container.scrollLeft}),this.scrolled=!1):(this.displaying=!1,this.scrolled=!1),this.tick.call(window,this.check.bind(this))},EPUBJS.Infinite.prototype.checkTop=function(){var t=this.container.scrollTop,e=this.container.scrollHeight,i=t-this.prevScrollTop,n=this.container.getBoundingClientRect().height,r=t+this.offset>e-n,o=t<this.offset;return r&&i>0?this.forwards():o&&0>i&&this.backwards(),this.prevScrollTop=t,t},EPUBJS.Infinite.prototype.checkLeft=function(){var t=this.container.scrollLeft,e=this.container.scrollWidth,i=t-this.prevscrollLeft,n=this.container.getBoundingClientRect().width,r=t+this.offset>e-n,o=t<this.offset;return r&&i>0?this.forwards():o&&0>i&&this.backwards(),this.prevscrollLeft=t,t},EPUBJS.Infinite.prototype.scrollBy=function(t,e,i){i&&(this.displaying=!0),this.container.scrollLeft+=t,this.container.scrollTop+=e,this.scrolled=!0,this.check()},EPUBJS.Infinite.prototype.scrollTo=function(t,e,i){i&&(this.displaying=!0),this.container.scrollLeft=t,this.container.scrollTop=e,this.scrolled=!0,this.check()},RSVP.EventTarget.mixin(EPUBJS.Infinite.prototype),EPUBJS.Layout=EPUBJS.Layout||{},EPUBJS.Layout.Reflowable=function(){this.documentElement=null,this.spreadWidth=null},EPUBJS.Layout.Reflowable.prototype.format=function(t,e,i,n){var r=EPUBJS.core.prefixed("columnAxis"),o=EPUBJS.core.prefixed("columnGap"),s=EPUBJS.core.prefixed("columnWidth"),h=EPUBJS.core.prefixed("columnFill"),a=Math.floor(e),c=Math.floor(a/8),p=n>=0?n:c%2===0?c:c-1;return this.documentElement=t,this.spreadWidth=a+p,t.style.overflow="hidden",t.style.width=a+"px",t.style.height=i+"px",t.style[r]="horizontal",t.style[h]="auto",t.style[s]=a+"px",t.style[o]=p+"px",this.colWidth=a,this.gap=p,{pageWidth:this.spreadWidth,pageHeight:i}},EPUBJS.Layout.Reflowable.prototype.calculatePages=function(){var t,e;return this.documentElement.style.width="auto",t=this.documentElement.scrollWidth,e=Math.ceil(t/this.spreadWidth),{displayedPages:e,pageCount:e}},EPUBJS.Layout.ReflowableSpreads=function(){this.documentElement=null,this.spreadWidth=null},EPUBJS.Layout.ReflowableSpreads.prototype.format=function(t,e,i,n){var r=EPUBJS.core.prefixed("columnAxis"),o=EPUBJS.core.prefixed("columnGap"),s=EPUBJS.core.prefixed("columnWidth"),h=EPUBJS.core.prefixed("columnFill"),a=2,c=Math.floor(e),p=c%2===0?c:c-1,l=Math.floor(p/8),d=n>=0?n:l%2===0?l:l-1,u=Math.floor((p-d)/a);return this.spreadWidth=(u+d)*a,t.document.documentElement.style.overflow="hidden",t.document.body.style.width=p+"px",t.document.body.style.height=i+"px",t.document.body.style[r]="horizontal",t.document.body.style[h]="auto",t.document.body.style[o]=d+"px",t.document.body.style[s]=u+"px",this.colWidth=u,this.gap=d,t.iframe.style.width=u+"px",t.iframe.style.paddingRight=d+"px",{pageWidth:this.spreadWidth,pageHeight:i}},EPUBJS.Layout.ReflowableSpreads.prototype.calculatePages=function(){var t=this.documentElement.scrollWidth,e=Math.ceil(t/this.spreadWidth);
return this.documentElement.style.width=t+this.spreadWidth+"px",{displayedPages:e,pageCount:2*e}},EPUBJS.Layout.Fixed=function(){this.documentElement=null},EPUBJS.Layout.Fixed=function(t){var e,i,n,r,o=EPUBJS.core.prefixed("columnWidth"),s=t.querySelector("[name=viewport");return this.documentElement=t,s&&s.hasAttribute("content")&&(e=s.getAttribute("content"),i=e.split(","),i[0]&&(n=i[0].replace("width=","")),i[1]&&(r=i[1].replace("height=",""))),t.style.width=n+"px"||"auto",t.style.height=r+"px"||"auto",t.style[o]="auto",t.style.overflow="auto",this.colWidth=n,this.gap=0,{pageWidth:n,pageHeight:r}},EPUBJS.Layout.Fixed.prototype.calculatePages=function(){return{displayedPages:1,pageCount:1}},EPUBJS.Navigation=function(t,e){var i=this,n=new EPUBJS.Parser,r=e||EPUBJS.core.request;this.package=t,this.toc=[],this.tocByHref={},this.tocById={},t.navPath&&(this.navUrl=t.baseUrl+t.navPath,this.nav={},this.nav.load=function(){var t=new RSVP.defer,e=t.promise;return r(i.navUrl,"xml").then(function(e){i.toc=n.nav(e),i.loaded(i.toc),t.resolve(i.toc)}),e}),t.ncxPath&&(this.ncxUrl=t.baseUrl+t.ncxPath,this.ncx={},this.ncx.load=function(){var t=new RSVP.defer,e=t.promise;return r(i.ncxUrl,"xml").then(function(e){i.toc=n.ncx(e),i.loaded(i.toc),t.resolve(i.toc)}),e})},EPUBJS.Navigation.prototype.load=function(t){{var e,i;t||EPUBJS.core.request}return this.nav?e=this.nav.load():this.ncx?e=this.ncx.load():(i=new RSVP.defer,i.resolve([]),e=i.promise),e},EPUBJS.Navigation.prototype.loaded=function(t){for(var e,i=0;i<t.length;i++)e=t[i],this.tocByHref[e.href]=i,this.tocById[e.id]=i},EPUBJS.Navigation.prototype.get=function(t){var e;return t?(0===t.indexOf("#")?e=this.tocById[t.substring(1)]:t in this.tocByHref&&(e=this.tocByHref[t]),this.toc[e]):this.toc},EPUBJS.Paginate=function(t,e){var i=e||{},n={width:600,height:400,forceSingle:!1,minSpreadWidth:800,gap:"auto",layoutOveride:null};this.settings=EPUBJS.core.defaults(i,n),this.renderer=t,this.isForcedSingle=!1,this.initialize()},EPUBJS.Paginate.prototype.determineSpreads=function(t){return this.isForcedSingle||!t||this.width<t?!1:!0},EPUBJS.Paginate.prototype.forceSingle=function(t){this.isForcedSingle=t?!0:!1},EPUBJS.Paginate.prototype.determineLayout=function(t){var e=this.determineSpreads(this.settings.minSpreadWidth),i=e?"ReflowableSpreads":"Reflowable",n=!1;return"pre-paginated"===t.layout&&(i="Fixed",n=!0,e=!1),"reflowable"===t.layout&&"none"===t.spread&&(i="Reflowable",n=!1,e=!1),"reflowable"===t.layout&&"both"===t.spread&&(i="ReflowableSpreads",n=!1,e=!0),this.spreads=e,i},EPUBJS.Paginate.prototype.reconcileLayoutSettings=function(t,e){var i={};for(var n in t)t.hasOwnProperty(n)&&(i[n]=t[n]);return e.forEach(function(t){var e,n,r=t.replace("rendition:",""),o=r.indexOf("-");-1!=o&&(e=r.slice(0,o),n=r.slice(o+1),i[e]=n)}),i},EPUBJS.Paginate.prototype.initialize=function(){this.renderer.hooks.display.register(this.registerLayoutMethod.bind(this)),this.currentPage=0},EPUBJS.Paginate.prototype.registerLayoutMethod=function(t){var e=new RSVP.defer;return this.layoutMethod=this.determineLayout({}),this.layout=new EPUBJS.Layout[this.layoutMethod],this.formated=this.layout.format(t,this.settings.width,this.settings.height,this.settings.gap),this.renderer.infinite.offset=this.formated.pageWidth,e.resolve(),e.promise},EPUBJS.Paginate.prototype.page=function(t){this.currentPage=t,this.renderer.infinite.scrollTo(this.currentPage*this.formated.pageWidth,0)},EPUBJS.Paginate.prototype.next=function(){return this.page(this.currentPage+1)},EPUBJS.Paginate.prototype.prev=function(){return this.page(this.currentPage-1)},EPUBJS.Paginate.prototype.display=function(t){return this.renderer.display(t)},EPUBJS.Parser=function(){},EPUBJS.Parser.prototype.container=function(t){var e,i,n,r;return t?(e=t.querySelector("rootfile"))?(i=e.getAttribute("full-path"),n=EPUBJS.core.uri(i).directory,r=t.xmlEncoding,{packagePath:i,basePath:n,encoding:r}):(console.error("No RootFile Found"),void 0):(console.error("Container File Not Found"),void 0)},EPUBJS.Parser.prototype.identifier=function(t){var e;return t?(e=t.querySelector("metadata"),e?this.getElementText(e,"identifier"):(console.error("No Metadata Found"),void 0)):(console.error("Package File Not Found"),void 0)},EPUBJS.Parser.prototype.packageContents=function(t){var e,i,n,r,o,s,h,a,c,p=this;return t?(e=t.querySelector("metadata"))?(i=t.querySelector("manifest"))?(n=t.querySelector("spine"))?(r=p.manifest(i),o=p.findNavPath(i),s=p.findNcxPath(i),h=p.findCoverPath(i),a=Array.prototype.indexOf.call(n.parentNode.childNodes,n),c=p.spine(n,r),{metadata:p.metadata(e),spine:c,manifest:r,navPath:o,ncxPath:s,coverPath:h,spineNodeIndex:a}):(console.error("No Spine Found"),void 0):(console.error("No Manifest Found"),void 0):(console.error("No Metadata Found"),void 0):(console.error("Package File Not Found"),void 0)},EPUBJS.Parser.prototype.findNavPath=function(t){var e=t.querySelector("item[properties^='nav']");return e?e.getAttribute("href"):!1},EPUBJS.Parser.prototype.findNcxPath=function(t){var e=t.querySelector("item[media-type='application/x-dtbncx+xml']");return e?e.getAttribute("href"):!1},EPUBJS.Parser.prototype.findCoverPath=function(t){var e=t.querySelector("item[properties='cover-image']");return e?e.getAttribute("href"):!1},EPUBJS.Parser.prototype.metadata=function(t){var e={},i=this;return e.title=i.getElementText(t,"title"),e.creator=i.getElementText(t,"creator"),e.description=i.getElementText(t,"description"),e.pubdate=i.getElementText(t,"date"),e.publisher=i.getElementText(t,"publisher"),e.identifier=i.getElementText(t,"identifier"),e.language=i.getElementText(t,"language"),e.rights=i.getElementText(t,"rights"),e.modified_date=i.querySelectorText(t,"meta[property='dcterms:modified']"),e.layout=i.querySelectorText(t,"meta[property='rendition:layout']"),e.orientation=i.querySelectorText(t,"meta[property='rendition:orientation']"),e.spread=i.querySelectorText(t,"meta[property='rendition:spread']"),e},EPUBJS.Parser.prototype.getElementText=function(t,e){var i,n=t.getElementsByTagNameNS("http://purl.org/dc/elements/1.1/",e);return n&&0!==n.length?(i=n[0],i.childNodes.length?i.childNodes[0].nodeValue:""):""},EPUBJS.Parser.prototype.querySelectorText=function(t,e){var i=t.querySelector(e);return i&&i.childNodes.length?i.childNodes[0].nodeValue:""},EPUBJS.Parser.prototype.manifest=function(t){var e={},i=t.querySelectorAll("item"),n=Array.prototype.slice.call(i);return n.forEach(function(t){var i=t.getAttribute("id"),n=t.getAttribute("href")||"",r=t.getAttribute("media-type")||"",o=t.getAttribute("properties")||"";e[i]={href:n,type:r,properties:o}}),e},EPUBJS.Parser.prototype.spine=function(t){var e=[],i=t.getElementsByTagName("itemref"),n=Array.prototype.slice.call(i);return n.forEach(function(t,i){var n=t.getAttribute("idref"),r=t.getAttribute("properties")||"",o=r.length?r.split(" "):[],s={idref:n,linear:t.getAttribute("linear")||"",properties:o,index:i};e.push(s)}),e},EPUBJS.Parser.prototype.nav=function(t){function e(t){var e=[];return Array.prototype.slice.call(t.childNodes).forEach(function(t){"ol"==t.tagName&&Array.prototype.slice.call(t.childNodes).forEach(function(t){"li"==t.tagName&&e.push(t)})}),e}function i(t){var e=null;return Array.prototype.slice.call(t.childNodes).forEach(function(t){("a"==t.tagName||"span"==t.tagName)&&(e=t)}),e}function n(t){var r=[],o=e(t),s=Array.prototype.slice.call(o),h=s.length;return 0===h?!1:(s.forEach(function(e){var o=e.getAttribute("id")||!1,s=i(e),h=s.getAttribute("href")||"",a=s.textContent||"",c=h.split("#"),p=(c[0],n(e));r.push({id:o,href:h,label:a,subitems:p,parent:t?t.getAttribute("id"):null})}),r)}var r=t.querySelector('nav[*|type="toc"]');return r?n(r):[]},EPUBJS.Parser.prototype.ncx=function(t){function e(i){var n=[],r=t.evaluate("*[local-name()='navPoint']",i,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),o=r.snapshotLength;if(0===o)return[];for(var s=o-1;s>=0;s--){var h=r.snapshotItem(s),a=h.getAttribute("id")||!1,c=h.querySelector("content"),p=c.getAttribute("src"),l=h.querySelector("navLabel"),d=l.textContent?l.textContent:"",u=p.split("#"),f=(u[0],e(h));n.unshift({id:a,href:p,label:d,subitems:f,parent:i?i.getAttribute("id"):null})}return n}var i=t.querySelector("navMap");return i?e(i):[]},EPUBJS.Renderer=function(t,e){var i=e||{};this.settings={infinite:"undefined"==typeof i.infinite?!0:i.infinite,hidden:"undefined"==typeof i.hidden?!1:i.hidden,axis:i.axis||"vertical",viewsLimit:i.viewsLimit||5,width:"undefined"==typeof i.width?!1:i.width,height:"undefined"==typeof i.height?!1:i.height,overflow:"undefined"==typeof i.overflow?"auto":i.overflow,padding:i.padding||"",offset:400},this.book=t,this.epubcfi=new EPUBJS.EpubCFI,this.layoutSettings={},this._q=EPUBJS.core.queue(this),this.position=1,this.initialize({width:this.settings.width,height:this.settings.height}),this.rendering=!1,this.filling=!1,this.displaying=!1,this.views=[],this.positions=[],this.hooks={},this.hooks.display=new EPUBJS.Hook(this),this.hooks.replacements=new EPUBJS.Hook(this),this.settings.infinite||(this.settings.viewsLimit=1)},EPUBJS.Renderer.prototype.initialize=function(t){{var e=t||{},i=e.height!==!1?e.height:"100%",n=e.width!==!1?e.width:"100%";e.hidden||!1}return e.height&&EPUBJS.core.isNumber(e.height)&&(i=e.height+"px"),e.width&&EPUBJS.core.isNumber(e.width)&&(n=e.width+"px"),this.container=document.createElement("div"),this.settings.infinite&&(this.infinite=new EPUBJS.Infinite(this.container,this.settings.axis),this.infinite.on("scroll",this.checkCurrent.bind(this))),"horizontal"===this.settings.axis&&(this.container.style.whiteSpace="nowrap"),this.container.style.width=n,this.container.style.height=i,this.container.style.overflow=this.settings.overflow,e.hidden?(this.wrapper=document.createElement("div"),this.wrapper.style.visibility="hidden",this.wrapper.style.overflow="hidden",this.wrapper.style.width="0",this.wrapper.style.height="0",this.wrapper.appendChild(this.container),this.wrapper):this.container},EPUBJS.Renderer.prototype.resize=function(t,e){var i=t,n=e,r=window.getComputedStyle(this.container),o={left:parseFloat(r["padding-left"])||0,right:parseFloat(r["padding-right"])||0,top:parseFloat(r["padding-top"])||0,bottom:parseFloat(r["padding-bottom"])||0},s=i-o.left-o.right,h=n-o.top-o.bottom;t||(i=window.innerWidth),e||(n=window.innerHeight),this.trigger("resized",{width:this.width,height:this.height}),this.views.forEach(function(t){"vertical"===this.settings.axis?t.resize(s,0):t.resize(0,h)}.bind(this))},EPUBJS.Renderer.prototype.onResized=function(){var t=this.element.getBoundingClientRect();this.resize(t.width,t.height)},EPUBJS.Renderer.prototype.attachTo=function(t){var e;return EPUBJS.core.isElement(t)?this.element=t:"string"==typeof t&&(this.element=document.getElementById(t)),this.element?(this.element.appendChild(this.container),this.settings.height||this.settings.width||(e=this.element.getBoundingClientRect(),this.resize(e.width,e.height)),this.settings.infinite&&(this.infinite.start(),this.infinite.on("forwards",function(){var t=this.last().section.index+1;!this.rendering&&!this.filling&&!this.displaying&&t<this.book.spine.length&&this.forwards()}.bind(this)),this.infinite.on("backwards",function(){var t=this.first().section.index-1;!this.rendering&&!this.filling&&!this.displaying&&t>0&&this.backwards()}.bind(this))),window.addEventListener("resize",this.onResized.bind(this),!1),this.hooks.replacements.register(this.replacements.bind(this)),this.hooks.display.register(this.afterDisplay.bind(this)),void 0):(console.error("Not an Element"),void 0)},EPUBJS.Renderer.prototype.clear=function(){this.views.forEach(function(t){t.destroy()}),this.views=[]},EPUBJS.Renderer.prototype.display=function(t){var e=new RSVP.defer,i=e.promise;return"string"==typeof t&&(t=t.split("#")[0]),this.book.opened.then(function(){var i,n=this.book.spine.get(t);this.displaying=!0,n?(this.clear(),i=this.render(n),this.settings.infinite&&i.then(function(){return this.fill.call(this)}.bind(this)),i.then(function(){this.trigger("displayed",n),this.displaying=!1,e.resolve(this)}.bind(this))):e.reject(new Error("No Section Found"))}.bind(this)),i},EPUBJS.Renderer.prototype.render=function(t){var e,i,n=this.container.getBoundingClientRect(),r=window.getComputedStyle(this.container),o={left:parseFloat(r["padding-left"])||0,right:parseFloat(r["padding-right"])||0,top:parseFloat(r["padding-top"])||0,bottom:parseFloat(r["padding-bottom"])||0},s=n.width-o.left-o.right,h=n.height-o.top-o.bottom;return t?(i=new EPUBJS.View(t),"vertical"===this.settings.axis?i.create(s,0):i.create(0,h),this.insert(i,t.index),e=i.render(this.book.request),e.then(function(){return this.hooks.display.trigger(i)}.bind(this)).then(function(){return this.hooks.replacements.trigger(i,this)}.bind(this)).then(function(){return i.expand()}.bind(this)).then(function(){return this.rendering=!1,i.show(),this.trigger("rendered",i.section),i}.bind(this)).catch(function(t){this.trigger("loaderror",t)}.bind(this))):(e=new RSVP.defer,e.reject(new Error("No Section Provided")),e.promise)},EPUBJS.Renderer.prototype.forwards=function(){var t,e,i;return t=this.last().section.index+1,this.rendering||t===this.book.spine.length?(e=new RSVP.defer,e.reject(new Error("Reject Forwards")),e.promise):(this.rendering=!0,i=this.book.spine.get(t),e=this.render(i),e.then(function(){var t=this.first(),e=t.bounds(),i=(this.last().bounds(),this.container.scrollTop),n=this.container.scrollLeft;this.views.length>this.settings.viewsLimit&&this.container.scrollTop-e.height>100&&(this.remove(t),this.settings.infinite&&("vertical"===this.settings.axis?this.infinite.scrollTo(0,i-e.height,!0):this.infinite.scrollTo(n-e.width,!0))),this.rendering=!1}.bind(this)),e)},EPUBJS.Renderer.prototype.backwards=function(){var t,e,i;return t=this.first().section.index-1,this.rendering||0>t?(e=new RSVP.defer,e.reject(new Error("Reject Backwards")),e.promise):(this.rendering=!0,i=this.book.spine.get(t),e=this.render(i),e.then(function(){var t;this.settings.infinite&&("vertical"===this.settings.axis?this.infinite.scrollBy(0,this.first().bounds().height,!0):this.infinite.scrollBy(this.first().bounds().width,0,!0)),this.views.length>this.settings.viewsLimit&&(t=this.last(),this.remove(t),this.container.scrollTop-this.first().bounds().height>100&&this.remove(t)),this.rendering=!1}.bind(this)),e)},EPUBJS.Renderer.prototype.fill=function(){var t=this.first().section.index-1,e=this.forwards();return this.filling=!0,"vertical"===this.settings.axis?e.then(this.fillVertical.bind(this)):e.then(this.fillHorizontal.bind(this)),t>0&&e.then(this.backwards.bind(this)),e.then(function(){this.filling=!1}.bind(this))},EPUBJS.Renderer.prototype.fillVertical=function(){var t=this.container.getBoundingClientRect().height,e=this.last().bounds().bottom,i=new RSVP.defer;return t&&e&&t>e?this.forwards().then(this.fillVertical.bind(this)):(this.rendering=!1,i.resolve(),i.promise)},EPUBJS.Renderer.prototype.fillHorizontal=function(){var t=this.container.getBoundingClientRect().width,e=this.last().bounds().right,i=new RSVP.defer;return t&&e&&t>=e?this.forwards().then(this.fillHorizontal.bind(this)):(this.rendering=!1,i.resolve(),i.promise)},EPUBJS.Renderer.prototype.append=function(t){this.views.push(t),t.appendTo(this.container)},EPUBJS.Renderer.prototype.prepend=function(t){this.views.unshift(t),t.prependTo(this.container)},EPUBJS.Renderer.prototype.insert=function(t,e){this.first()?e-this.first().section.index>=0?this.append(t):e-this.last().section.index<=0&&this.prepend(t):this.append(t)},EPUBJS.Renderer.prototype.remove=function(t){var e=this.views.indexOf(t);t.destroy(),e>-1&&this.views.splice(e,1)},EPUBJS.Renderer.prototype.first=function(){return this.views[0]},EPUBJS.Renderer.prototype.last=function(){return this.views[this.views.length-1]},EPUBJS.Renderer.prototype.replacements=function(t,e){for(var i=new RSVP.defer,n=t.document.querySelectorAll("a[href]"),r=function(t){var i=t.getAttribute("href"),n=new EPUBJS.core.uri(i);n.protocol?t.setAttribute("target","_blank"):0===i.indexOf("#")||(t.onclick=function(){return e.display(i),!1})},o=0;o<n.length;o++)r(n[o]);return i.resolve(),i.promise},EPUBJS.Renderer.prototype.afterDisplay=function(){var t=new RSVP.defer;return t.resolve(),t.promise},EPUBJS.Renderer.prototype.paginate=function(){return this.pagination=new EPUBJS.Paginate(this,{width:this.settings.width,height:this.settings.height}),this.pagination},EPUBJS.Renderer.prototype.checkCurrent=function(){var t,e,i=this.container.getBoundingClientRect(),n=this.views.length-1;if(!this.rendering)if("horizontal"===this.settings.axis);else for(var r=n;r>=0;r--)if(t=this.views[r],e=t.bounds().top,e<i.bottom){if(this.current==t.section)break;this.current=t.section,this.trigger("current",this.current);break}},EPUBJS.Renderer.prototype.bounds=function(){return this.container.getBoundingClientRect()},RSVP.EventTarget.mixin(EPUBJS.Renderer.prototype),EPUBJS.Rendition=function(t,e){this.settings=EPUBJS.core.defaults(e||{},{infinite:!0,hidden:!1,width:!1,height:!1,overflow:"auto",axis:"vertical",offset:500}),this.book=t,this.container=this.initialize({width:this.settings.width,height:this.settings.height}),this.settings.hidden&&(this.wrapper=this.wrap(this.container)),this.views=[],this.tick=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,this.scrolled=!1,this.hooks={},this.hooks.display=new EPUBJS.Hook(this),this.hooks.replacements=new EPUBJS.Hook(this),this.container.addEventListener("scroll",function(){this.ignore?this.ignore=!1:this.scrolled=!0}.bind(this))},EPUBJS.Rendition.prototype.handleScroll=function(){this.scrolled&&!this.displaying?(this.check(),this.scrolled=!1):(this.displaying=!1,this.scrolled=!1),this.tick.call(window,this.handleScroll.bind(this))},EPUBJS.Rendition.prototype.initialize=function(t){{var e,i=t||{},n=i.height!==!1?i.height:"100%",r=i.width!==!1?i.width:"100%";i.hidden||!1}return i.height&&EPUBJS.core.isNumber(i.height)&&(n=i.height+"px"),i.width&&EPUBJS.core.isNumber(i.width)&&(r=i.width+"px"),e=document.createElement("div"),"horizontal"===this.settings.axis&&(e.style.whiteSpace="nowrap"),e.style.width=r,e.style.height=n,e.style.overflow=this.settings.overflow,e},EPUBJS.Rendition.wrap=function(t){var e=document.createElement("div");return e.style.visibility="hidden",e.style.overflow="hidden",e.style.width="0",e.style.height="0",e.appendChild(t),e},EPUBJS.Rendition.prototype.attachTo=function(t){var e;return EPUBJS.core.isElement(t)?this.element=t:"string"==typeof t&&(this.element=document.getElementById(t)),this.element?(this.settings.height===!1&&(e=this.element.getBoundingClientRect(),this.container.style.height=e.height+"px"),this.settings.width===!1&&(e=e||this.element.getBoundingClientRect(),this.container.style.width=e.width+"px"),this.element.appendChild(this.container),this.attachListeners(),void 0):(console.error("Not an Element"),void 0)},EPUBJS.Rendition.prototype.attachListeners=function(){window.addEventListener("resize",this.onResized.bind(this),!1)},EPUBJS.Rendition.prototype.bounds=function(){return this.container.getBoundingClientRect()},EPUBJS.Rendition.prototype.display=function(t){var e=new RSVP.defer,i=e.promise;return"string"==typeof t&&(t=t.split("#")[0]),this.book.opened.then(function(){var i,n=this.book.spine.get(t);this.displaying=!0,n?(i=new EPUBJS.View(n),this.fill(i),this.check(),this.handleScroll(),i.displayed.then(function(){this.trigger("displayed",n),this.displaying=!1,e.resolve(this)}.bind(this))):e.reject(new Error("No Section Found"))}.bind(this)),i},EPUBJS.Rendition.prototype.render=function(t){return t.create(),this.resizeView(t),t.display(this.book.request).then(function(){return this.hooks.display.trigger(t)}.bind(this)).then(function(){return this.hooks.replacements.trigger(t,this)}.bind(this)).then(function(){return t.expand()}.bind(this)).then(function(){return this.rendering=!1,t.show(),this.trigger("rendered",t.section),this.check(),t}.bind(this)).catch(function(t){this.trigger("loaderror",t)}.bind(this))},EPUBJS.Rendition.prototype.afterDisplayed=function(t){var e,i,n=t.section.next(),r=t.section.prev(),o=this.views.indexOf(t);this.resizeView(t),o+1===this.views.length&&n&&(i=new EPUBJS.View(n),this.append(i)),0===o&&r&&(e=new EPUBJS.View(r),this.prepend(e))},EPUBJS.Rendition.prototype.append=function(t){this.views.push(t),this.container.appendChild(t.element),t.onShown=this.afterDisplayed.bind(this)},EPUBJS.Rendition.prototype.prepend=function(t){this.views.unshift(t),this.container.insertBefore(t.element,this.container.firstChild),t.onShown=function(t){var e,i,n,r,o=this.container.scrollTop,s=this.container.scrollLeft;this.afterDisplayed(t),e=t.bounds(),i=window.getComputedStyle(t.element),n=parseInt(i.marginTop)+parseInt(i.marginBottom)||0,r=parseInt(i.marginLeft)+parseInt(i.marginLeft)||0,"vertical"===this.settings.axis?this.scrollTo(0,o+e.height+n,!0):this.scrollTo(s+e.width-r,0,!0)}.bind(this)},EPUBJS.Rendition.prototype.fill=function(t){this.views.length&&this.clear(),this.views.push(t),this.container.appendChild(t.element),t.onShown=this.afterDisplayed.bind(this)},EPUBJS.Rendition.prototype.insert=function(t,e){this.views.splice(e,0,t),e<this.cotainer.children.length?this.container.insertBefore(t.element,this.container.children[e]):this.container.appendChild(t.element)},EPUBJS.Rendition.prototype.remove=function(t){var e=this.views.indexOf(t);e>-1&&this.views.splice(e,1),this.container.removeChild(t.element),t.shown&&t.destroy(),t=null},EPUBJS.Rendition.prototype.clear=function(){this.views.forEach(function(t){t.destroy()}),this.views=[]},EPUBJS.Rendition.prototype.first=function(){return this.views[0]},EPUBJS.Rendition.prototype.last=function(){return this.views[this.views.length-1]},EPUBJS.Rendition.prototype.each=function(t){return this.views.forEach(t)},EPUBJS.Rendition.prototype.check=function(){var t=this.container.getBoundingClientRect(),e=function(e){var i=e.bounds();i.bottom>=t.top-this.settings.offset&&!(i.top>t.bottom)&&i.right>=t.left&&!(i.left>t.right)?e.shown||(console.log("render",e.index),this.render(e)):e.shown&&e.destroy()}.bind(this);this.views.forEach(function(t){e(t)}),clearTimeout(this.trimTimeout),this.trimTimeout=setTimeout(function(){this.trim(),console.log("TRIM")}.bind(this),250)},EPUBJS.Rendition.prototype.trim=function(){for(var t=0;t<this.views.length;t++){var e=this.views[t],i=t>0?this.views[t-1].shown:!1,n=t+1<this.views.length?this.views[t+1].shown:!1;e.shown||i||n||this.erase(e)}},EPUBJS.Rendition.prototype.erase=function(t){var e=this.container.scrollTop,i=this.container.scrollLeft,n=t.bounds(),r=window.getComputedStyle(t.element),o=parseInt(r.marginTop)+parseInt(r.marginBottom)||0,s=parseInt(r.marginLeft)+parseInt(r.marginLeft)||0;this.remove(t),t===this.first()&&(console.log("comp"),"vertical"===this.settings.axis?this.scrollTo(0,e-n.height-o,!0):this.scrollTo(i-n.width-s,0,!0))},EPUBJS.Rendition.prototype.scrollBy=function(t,e,i){i&&(this.displaying=!0),this.container.scrollLeft+=t,this.container.scrollTop+=e,this.scrolled=!0,this.check()},EPUBJS.Rendition.prototype.scrollTo=function(t,e,i){i&&(this.displaying=!0),this.container.scrollLeft=t,this.container.scrollTop=e,this.scrolled=!0,console.log("scrolled:",e),this.check()},EPUBJS.Rendition.prototype.resizeView=function(t){var e=this.container.getBoundingClientRect(),i=window.getComputedStyle(this.container),n={left:parseFloat(i["padding-left"])||0,right:parseFloat(i["padding-right"])||0,top:parseFloat(i["padding-top"])||0,bottom:parseFloat(i["padding-bottom"])||0},r=e.width-n.left-n.right,o=e.height-n.top-n.bottom;"vertical"===this.settings.axis?t.resize(r,0):t.resize(0,o)},EPUBJS.Rendition.prototype.resize=function(t,e){var i=t,n=e,r=window.getComputedStyle(this.container),o={left:parseFloat(r["padding-left"])||0,right:parseFloat(r["padding-right"])||0,top:parseFloat(r["padding-top"])||0,bottom:parseFloat(r["padding-bottom"])||0},s=i-o.left-o.right,h=n-o.top-o.bottom;t||(i=window.innerWidth),e||(n=window.innerHeight),this.trigger("resized",{width:this.width,height:this.height}),this.views.forEach(function(t){"vertical"===this.settings.axis?t.resize(s,0):t.resize(0,h)}.bind(this))},EPUBJS.Rendition.prototype.onResized=function(){var t=this.element.getBoundingClientRect();this.resize(t.width,t.height)},RSVP.EventTarget.mixin(EPUBJS.Rendition.prototype),EPUBJS.Section=function(t){this.idref=t.idref,this.linear=t.linear,this.properties=t.properties,this.index=t.index,this.href=t.href,this.url=t.url,this.cfiBase=t.cfiBase,this.next=t.next,this.prev=t.prev,this.hooks={},this.hooks.replacements=new EPUBJS.Hook(this),this.hooks.replacements.register(this.replacements)},EPUBJS.Section.prototype.load=function(t){var e=t||this.request||EPUBJS.core.request,i=new RSVP.defer,n=i.promise;return this.contents?i.resolve(this.contents):e(this.url,"xml").then(function(t){EPUBJS.core.folder(this.url);return this.document=t,this.contents=t.documentElement,this.hooks.replacements.trigger(this.document)}.bind(this)).then(function(){i.resolve(this.contents)}.bind(this)).catch(function(t){i.reject(t)}),n},EPUBJS.Section.prototype.replacements=function(t){var e,i=new RSVP.defer,n=t.createElement("base");return n.setAttribute("href",this.url),t&&(e=t.querySelector("head")),e?(e.insertBefore(n,e.firstChild),i.resolve()):i.reject(new Error("No head to insert into")),i.promise},EPUBJS.Section.prototype.beforeSectionLoad=function(){},EPUBJS.Section.prototype.render=function(t){var e=new RSVP.defer,i=e.promise;return this.load(t).then(function(t){var i=new XMLSerializer,n=i.serializeToString(t);e.resolve(n)}).catch(function(t){e.reject(t)}),i},EPUBJS.Section.prototype.find=function(){},EPUBJS.Spine=function(t){this.request=t,this.spineItems=[],this.spineByHref={},this.spineById={}},EPUBJS.Spine.prototype.load=function(t){this.items=t.spine,this.manifest=t.manifest,this.spineNodeIndex=t.spineNodeIndex,this.baseUrl=t.baseUrl||"",this.length=this.items.length,this.epubcfi=new EPUBJS.EpubCFI,this.items.forEach(function(t,e){var i,n=this.manifest[t.idref];t.cfiBase=this.epubcfi.generateChapterComponent(this.spineNodeIndex,t.index,t.idref),n&&(t.href=n.href,t.url=this.baseUrl+t.href),t.prev=function(){return this.get(e-1)}.bind(this),t.next=function(){return this.get(e+1)}.bind(this),i=new EPUBJS.Section(t),this.append(i)}.bind(this))},EPUBJS.Spine.prototype.get=function(t){var e=0;return!t||"number"!=typeof t&&isNaN(t)!==!1?t&&0===t.indexOf("#")?e=this.spineById[t.substring(1)]:t&&(e=this.spineByHref[t]):e=t,this.spineItems[e]||null},EPUBJS.Spine.prototype.append=function(t){var e=this.spineItems.length;return t.index=e,this.spineItems.push(t),this.spineByHref[t.href]=e,this.spineById[t.idref]=e,e},EPUBJS.Spine.prototype.prepend=function(t){this.spineItems.unshift(t);return this.spineByHref[t.href]=0,this.spineById[t.idref]=0,this.spineItems.forEach(function(t,e){t.index=e}),0},EPUBJS.Spine.prototype.insert=function(){},EPUBJS.Spine.prototype.remove=function(t){var e=this.spineItems.indexOf(t);return e>-1?(delete this.spineByHref[t.href],delete this.spineById[t.idref],this.spineItems.splice(e,1)):void 0},EPUBJS.View=function(t){this.id="epubjs-view:"+EPUBJS.core.uuid(),this.displaying=new RSVP.defer,this.displayed=this.displaying.promise,this.section=t,this.index=t.index,this.element=document.createElement("div"),this.element.classList.add("epub-view"),this.element.style.display="inline-block",this.element.style.height=0,this.element.style.width=0,this.shown=!1,this.rendered=!1},EPUBJS.View.prototype.create=function(t,e){return this.iframe=document.createElement("iframe"),this.iframe.id=this.id,this.iframe.scrolling="no",this.iframe.seamless="seamless",this.iframe.style.border="none",this.resizing=!0,(t||e)&&this.resize(t,e),this.iframe.style.display="none",this.iframe.style.visibility="hidden",this.element.appendChild(this.iframe),this.rendered=!0,this.iframe},EPUBJS.View.prototype.resize=function(t,e){t&&(this.iframe&&(this.iframe.style.width=t+"px"),this.element.style.width=t+"px"),e&&(this.iframe&&(this.iframe.style.height=e+"px"),this.element.style.height=e+"px"),this.resizing||(this.resizing=!0,this.iframe&&this.expand())},EPUBJS.View.prototype.resized=function(){this.resizing?this.resizing=!1:this.expand()},EPUBJS.View.prototype.display=function(t){return this.shown=!0,this.section.render(t).then(function(t){return this.load(t)}.bind(this)).then(this.afterLoad.bind(this)).then(this.displaying.resolve.call(this))},EPUBJS.View.prototype.load=function(t){var e=new RSVP.defer,i=e.promise;return this.document=this.iframe.contentDocument,this.document?(this.iframe.addEventListener("load",function(){this.window=this.iframe.contentWindow,this.document=this.iframe.contentDocument,e.resolve(this)}.bind(this)),this.document.open(),this.document.write(t),this.document.close(),i):(e.reject(new Error("No Document Available")),i)},EPUBJS.View.prototype.afterLoad=function(){this.iframe.style.display="inline-block",this.document.body.style.margin="0",this.document.body.style.display="inline-block",this.document.documentElement.style.width="auto",setTimeout(function(){this.window.addEventListener("resize",this.resized.bind(this),!1)}.bind(this),10),"loading"===this.document.fonts.status&&(this.document.fonts.onloading=function(){this.expand()}.bind(this)),this.observe&&(this.observer=this.observe(this.document.body))},EPUBJS.View.prototype.expand=function(t,e){var i,n,r,o=t||new RSVP.defer,s=o.promise,h=10,a=e||0;return this.resizing=!0,i=this.document.body.getBoundingClientRect(),!i||0===i.height&&0===i.width?(console.error("View not shown"),s):(r=i.height,n=this.document.documentElement.scrollWidth,this.width!=n||this.height!=r?setTimeout(function(){this.expand(o,a)}.bind(this),h):o.resolve(),this.width=n,this.height=r,this.resize(n,r),s)},EPUBJS.View.prototype.observe=function(t){var e=this,i=new MutationObserver(function(){e.expand()}),n={attributes:!0,childList:!0,characterData:!0,subtree:!0};return i.observe(t,n),i},EPUBJS.View.prototype.onShown=function(){},EPUBJS.View.prototype.show=function(){this.iframe.style.display="inline-block",this.iframe.style.visibility="visible",this.onShown(this),this.shown=!0},EPUBJS.View.prototype.hide=function(){this.iframe.style.display="none",this.iframe.style.visibility="hidden"},EPUBJS.View.prototype.bounds=function(){return this.element.getBoundingClientRect()},EPUBJS.View.prototype.destroy=function(){this.iframe&&(this.element.removeChild(this.iframe),this.shown=!1,this.iframe=null)},EPUBJS.ViewManager=function(t){this.views=[],this.container=t},EPUBJS.ViewManager.prototype.append=function(t){this.views.push(t),this.container.appendChild(t.element())},EPUBJS.ViewManager.prototype.prepend=function(t){this.views.unshift(t),this.container.insertBefore(t.element(),this.container.firstChild)},EPUBJS.ViewManager.prototype.insert=function(t,e){this.views.splice(e,0,t),e<this.cotainer.children.length?this.container.insertBefore(t.element(),this.container.children[e]):this.container.appendChild(t.element())},EPUBJS.Renderer.prototype.add=function(t){var e=(t.section,-1);0===this.views.length||t.index>this.last().index?(this.append(t),e=this.views.length):t.index<this.first().index?(this.prepend(t),e=0):(e=EPUBJS.core.locationOf(t,this.views,function(){return a.index>b.index?1:a.index<b.index?-1:0}),this.insert(t,e))},EPUBJS.ViewManager.prototype.remove=function(t){var e=this.views.indexOf(t);t.destroy(),e>-1&&this.views.splice(e,1)},EPUBJS.ViewManager.prototype.clear=function(){this.views.forEach(function(t){t.destroy()}),this.views=[]},EPUBJS.ViewManager.prototype.first=function(){return this.views[0]},EPUBJS.ViewManager.prototype.last=function(){return this.views[this.views.length-1]},EPUBJS.ViewManager.prototype.map=function(t){return this.views.map(t)};