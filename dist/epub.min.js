(function(){"use strict";function t(t,e){for(var i=0,n=t.length;n>i;i++)if(t[i]===e)return i;return-1}function e(t){var e=t._promiseCallbacks;return e||(e=t._promiseCallbacks={}),e}function i(t,e){return"onerror"===t?(Y.on("error",e),void 0):2!==arguments.length?Y[t]:(Y[t]=e,void 0)}function n(t){return"function"==typeof t||"object"==typeof t&&null!==t}function o(t){return"function"==typeof t}function r(t){return"object"==typeof t&&null!==t}function s(){}function a(){}function h(t){try{return t.then}catch(e){return re.error=e,re}}function u(t,e,i,n){try{t.call(e,i,n)}catch(o){return o}}function c(t,e,i){Y.async(function(t){var n=!1,o=u(i,e,function(i){n||(n=!0,e!==i?d(t,i):g(t,i))},function(e){n||(n=!0,y(t,e))},"Settle: "+(t._label||" unknown promise"));!n&&o&&(n=!0,y(t,o))},t)}function l(t,e){e._state===ne?g(t,e._result):t._state===oe?y(t,e._result):m(e,void 0,function(i){e!==i?d(t,i):g(t,i)},function(e){y(t,e)})}function p(t,e){if(e.constructor===t.constructor)l(t,e);else{var i=h(e);i===re?y(t,re.error):void 0===i?g(t,e):o(i)?c(t,e,i):g(t,e)}}function d(t,e){t===e?g(t,e):n(e)?p(t,e):g(t,e)}function f(t){t._onerror&&t._onerror(t._result),S(t)}function g(t,e){t._state===ie&&(t._result=e,t._state=ne,0===t._subscribers.length?Y.instrument&&ee("fulfilled",t):Y.async(S,t))}function y(t,e){t._state===ie&&(t._state=oe,t._result=e,Y.async(f,t))}function m(t,e,i,n){var o=t._subscribers,r=o.length;t._onerror=null,o[r]=e,o[r+ne]=i,o[r+oe]=n,0===r&&t._state&&Y.async(S,t)}function S(t){var e=t._subscribers,i=t._state;if(Y.instrument&&ee(i===ne?"fulfilled":"rejected",t),0!==e.length){for(var n,o,r=t._result,s=0;s<e.length;s+=3)n=e[s],o=e[s+i],n?P(i,n,o,r):o(r);t._subscribers.length=0}}function v(){this.error=null}function E(t,e){try{return t(e)}catch(i){return se.error=i,se}}function P(t,e,i,n){var r,s,a,h,u=o(i);if(u){if(r=E(i,n),r===se?(h=!0,s=r.error,r=null):a=!0,e===r)return y(e,new TypeError("A promises callback cannot return that same promise.")),void 0}else r=n,a=!0;e._state!==ie||(u&&a?d(e,r):h?y(e,s):t===ne?g(e,r):t===oe&&y(e,r))}function B(t,e){try{e(function(e){d(t,e)},function(e){y(t,e)})}catch(i){y(t,i)}}function w(t,e,i){return t===ne?{state:"fulfilled",value:i}:{state:"rejected",reason:i}}function U(t,e,i,n){this._instanceConstructor=t,this.promise=new t(a,n),this._abortOnReject=i,this._validateInput(e)?(this._input=e,this.length=e.length,this._remaining=e.length,this._init(),0===this.length?g(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&g(this.promise,this._result))):y(this.promise,this._validationError())}function b(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function J(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function x(t,e){this._id=de++,this._label=e,this._state=void 0,this._result=void 0,this._subscribers=[],Y.instrument&&ee("created",this),a!==t&&(o(t)||b(),this instanceof x||J(),B(this,t))}function C(){this.value=void 0}function R(t){try{return t.then}catch(e){return ge.value=e,ge}}function _(t,e,i){try{t.apply(e,i)}catch(n){return ge.value=n,ge}}function T(t,e){for(var i,n,o={},r=t.length,s=new Array(r),a=0;r>a;a++)s[a]=t[a];for(n=0;n<e.length;n++)i=e[n],o[i]=s[n+1];return o}function k(t){for(var e=t.length,i=new Array(e-1),n=1;e>n;n++)i[n-1]=t[n];return i}function N(t,e){return{then:function(i,n){return t.call(e,i,n)}}}function q(t,e,i,n){var o=_(i,n,e);return o===ge&&y(t,o.value),t}function L(t,e,i,n){return fe.all(e).then(function(e){var o=_(i,n,e);return o===ge&&y(t,o.value),t})}function O(t){return t&&"object"==typeof t?t.constructor===fe?!0:R(t):!1}function F(t,e,i){this._superConstructor(t,e,!1,i)}function I(t,e,i){this._superConstructor(t,e,!0,i)}function V(t,e,i){this._superConstructor(t,e,!1,i)}function A(){return function(){process.nextTick(z)}}function M(){var t=0,e=new qe(z),i=document.createTextNode("");return e.observe(i,{characterData:!0}),function(){i.data=t=++t%2}}function H(){var t=new MessageChannel;return t.port1.onmessage=z,function(){t.port2.postMessage(0)}}function j(){return function(){setTimeout(z,1)}}function z(){for(var t=0;Te>t;t+=2){var e=Oe[t],i=Oe[t+1];e(i),Oe[t]=void 0,Oe[t+1]=void 0}Te=0}function D(t,e){Y.async(t,e)}function W(){Y.on.apply(Y,arguments)}function X(){Y.off.apply(Y,arguments)}var Q={mixin:function(t){return t.on=this.on,t.off=this.off,t.trigger=this.trigger,t._promiseCallbacks=void 0,t},on:function(i,n){var o,r=e(this);o=r[i],o||(o=r[i]=[]),-1===t(o,n)&&o.push(n)},off:function(i,n){var o,r,s=e(this);return n?(o=s[i],r=t(o,n),-1!==r&&o.splice(r,1),void 0):(s[i]=[],void 0)},trigger:function(t,i){var n,o,r=e(this);if(n=r[t])for(var s=0;s<n.length;s++)o=n[s],o(i)}},Y={instrument:!1};Q.mixin(Y);var K;K=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};var G=K,Z=Date.now||function(){return(new Date).getTime()},$=Object.create||function(t){if(arguments.length>1)throw new Error("Second argument not supported");if("object"!=typeof t)throw new TypeError("Argument must be an object");return s.prototype=t,new s},te=[],ee=function(t,e,i){1===te.push({name:t,payload:{guid:e._guidKey+e._id,eventName:t,detail:e._result,childGuid:i&&e._guidKey+i._id,label:e._label,timeStamp:Z(),stack:new Error(e._label).stack}})&&setTimeout(function(){for(var t,e=0;e<te.length;e++)t=te[e],Y.trigger(t.name,t.payload);te.length=0},50)},ie=void 0,ne=1,oe=2,re=new v,se=new v;U.prototype._validateInput=function(t){return G(t)},U.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")},U.prototype._init=function(){this._result=new Array(this.length)};var ae=U;U.prototype._enumerate=function(){for(var t=this.length,e=this.promise,i=this._input,n=0;e._state===ie&&t>n;n++)this._eachEntry(i[n],n)},U.prototype._eachEntry=function(t,e){var i=this._instanceConstructor;r(t)?t.constructor===i&&t._state!==ie?(t._onerror=null,this._settledAt(t._state,e,t._result)):this._willSettleAt(i.resolve(t),e):(this._remaining--,this._result[e]=this._makeResult(ne,e,t))},U.prototype._settledAt=function(t,e,i){var n=this.promise;n._state===ie&&(this._remaining--,this._abortOnReject&&t===oe?y(n,i):this._result[e]=this._makeResult(t,e,i)),0===this._remaining&&g(n,this._result)},U.prototype._makeResult=function(t,e,i){return i},U.prototype._willSettleAt=function(t,e){var i=this;m(t,void 0,function(t){i._settledAt(ne,e,t)},function(t){i._settledAt(oe,e,t)})};var he=function(t,e){return new ae(this,t,!0,e).promise},ue=function(t,e){function i(t){d(r,t)}function n(t){y(r,t)}var o=this,r=new o(a,e);if(!G(t))return y(r,new TypeError("You must pass an array to race.")),r;for(var s=t.length,h=0;r._state===ie&&s>h;h++)m(o.resolve(t[h]),void 0,i,n);return r},ce=function(t,e){var i=this;if(t&&"object"==typeof t&&t.constructor===i)return t;var n=new i(a,e);return d(n,t),n},le=function(t,e){var i=this,n=new i(a,e);return y(n,t),n},pe="rsvp_"+Z()+"-",de=0,fe=x;x.cast=ce,x.all=he,x.race=ue,x.resolve=ce,x.reject=le,x.prototype={constructor:x,_guidKey:pe,_onerror:function(t){Y.trigger("error",t)},then:function(t,e,i){var n=this,o=n._state;if(o===ne&&!t||o===oe&&!e)return Y.instrument&&ee("chained",this,this),this;n._onerror=null;var r=new this.constructor(a,i),s=n._result;if(Y.instrument&&ee("chained",n,r),o){var h=arguments[o-1];Y.async(function(){P(o,r,h,s)})}else m(n,r,t,e);return r},"catch":function(t,e){return this.then(null,t,e)},"finally":function(t,e){var i=this.constructor;return this.then(function(e){return i.resolve(t()).then(function(){return e})},function(e){return i.resolve(t()).then(function(){throw e})},e)}};var ge=new C,ye=new C,me=function(t,e){var i=function(){for(var i,n=this,o=arguments.length,r=new Array(o+1),s=!1,h=0;o>h;++h){if(i=arguments[h],!s){if(s=O(i),s===ye){var u=new fe(a);return y(u,ye.value),u}s&&s!==!0&&(i=N(s,i))}r[h]=i}var c=new fe(a);return r[o]=function(t,i){t?y(c,t):void 0===e?d(c,i):e===!0?d(c,k(arguments)):G(e)?d(c,T(arguments,e)):d(c,i)},s?L(c,r,t,n):q(c,r,t,n)};return i.__proto__=t,i},Se=function(t,e){return fe.all(t,e)};F.prototype=$(ae.prototype),F.prototype._superConstructor=ae,F.prototype._makeResult=w,F.prototype._validationError=function(){return new Error("allSettled must be called with an array")};var ve=function(t,e){return new F(fe,t,e).promise},Ee=function(t,e){return fe.race(t,e)},Pe=I;I.prototype=$(ae.prototype),I.prototype._superConstructor=ae,I.prototype._init=function(){this._result={}},I.prototype._validateInput=function(t){return t&&"object"==typeof t},I.prototype._validationError=function(){return new Error("Promise.hash must be called with an object")},I.prototype._enumerate=function(){var t=this.promise,e=this._input,i=[];for(var n in e)t._state===ie&&e.hasOwnProperty(n)&&i.push({position:n,entry:e[n]});var o=i.length;this._remaining=o;for(var r,s=0;t._state===ie&&o>s;s++)r=i[s],this._eachEntry(r.entry,r.position)};var Be=function(t,e){return new Pe(fe,t,e).promise};V.prototype=$(Pe.prototype),V.prototype._superConstructor=ae,V.prototype._makeResult=w,V.prototype._validationError=function(){return new Error("hashSettled must be called with an object")};var we,Ue=function(t,e){return new V(fe,t,e).promise},be=function(t){throw setTimeout(function(){throw t}),t},Je=function(t){var e={};return e.promise=new fe(function(t,i){e.resolve=t,e.reject=i},t),e},xe=function(t,e,i){return fe.all(t,i).then(function(t){if(!o(e))throw new TypeError("You must pass a function as map's second argument.");for(var n=t.length,r=new Array(n),s=0;n>s;s++)r[s]=e(t[s]);return fe.all(r,i)})},Ce=function(t,e){return fe.resolve(t,e)},Re=function(t,e){return fe.reject(t,e)},_e=function(t,e,i){return fe.all(t,i).then(function(t){if(!o(e))throw new TypeError("You must pass a function as filter's second argument.");for(var n=t.length,r=new Array(n),s=0;n>s;s++)r[s]=e(t[s]);return fe.all(r,i).then(function(e){for(var i=new Array(n),o=0,r=0;n>r;r++)e[r]&&(i[o]=t[r],o++);return i.length=o,i})})},Te=0,ke=function(t,e){Oe[Te]=t,Oe[Te+1]=e,Te+=2,2===Te&&we()},Ne="undefined"!=typeof window?window:{},qe=Ne.MutationObserver||Ne.WebKitMutationObserver,Le="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,Oe=new Array(1e3);we="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?A():qe?M():Le?H():j(),Y.async=ke;if("undefined"!=typeof window&&"object"==typeof window.__PROMISE_INSTRUMENTATION__){var Fe=window.__PROMISE_INSTRUMENTATION__;i("instrument",!0);for(var Ie in Fe)Fe.hasOwnProperty(Ie)&&W(Ie,Fe[Ie])}var Ve={race:Ee,Promise:fe,allSettled:ve,hash:Be,hashSettled:Ue,denodeify:me,on:W,off:X,map:xe,filter:_e,resolve:Ce,reject:Re,all:Se,rethrow:be,defer:Je,EventTarget:Q,configure:i,async:D};"function"==typeof define&&define.amd?define(function(){return Ve}):"undefined"!=typeof module&&module.exports?module.exports=Ve:"undefined"!=typeof this&&(this.RSVP=Ve)}).call(this),"undefined"==typeof EPUBJS&&(("undefined"!=typeof window?window:this).EPUBJS={}),EPUBJS.VERSION="0.3.0",function(t){"use strict";var e=function(t){return new EPUBJS.Book(t)};"object"==typeof exports?(t.RSVP=require("rsvp"),module.exports=e):"function"==typeof define&&define.amd?define(e):t.ePub=e}(this),EPUBJS.core={},EPUBJS.core.request=function(t,e,i,n){function o(){if(this.readyState===this.DONE)if(200===this.status||this.responseXML){var t;t="xml"==e?this.responseXML?this.responseXML:(new DOMParser).parseFromString(this.response,"text/xml"):"json"==e?JSON.parse(this.response):"blob"==e?s?this.response:new Blob([this.response]):this.response,h.resolve(t)}else h.reject({status:this.status,message:this.response,stack:(new Error).stack})}var r,s=window.URL,a=s?"blob":"arraybuffer",h=new RSVP.defer,u=new XMLHttpRequest,c=XMLHttpRequest.prototype;"overrideMimeType"in c||Object.defineProperty(c,"overrideMimeType",{value:function(){}}),i&&(u.withCredentials=!0),u.open("GET",t,!0);for(r in n)u.setRequestHeader(r,n[r]);return u.onreadystatechange=o,"blob"==e&&(u.responseType=a),"json"==e&&u.setRequestHeader("Accept","application/json"),"xml"==e&&u.overrideMimeType("text/xml"),u.send(),h.promise},EPUBJS.core.uri=function(t){var e,i,n,o={protocol:"",host:"",path:"",origin:"",directory:"",base:"",filename:"",extension:"",fragment:"",href:t},r=t.indexOf("://"),s=t.indexOf("?"),a=t.indexOf("#");return-1!=a&&(o.fragment=t.slice(a+1),t=t.slice(0,a)),-1!=s&&(o.search=t.slice(s+1),t=t.slice(0,s),href=t),-1!=r?(o.protocol=t.slice(0,r),e=t.slice(r+3),n=e.indexOf("/"),-1===n?(o.host=o.path,o.path=""):(o.host=e.slice(0,n),o.path=e.slice(n)),o.origin=o.protocol+"://"+o.host,o.directory=EPUBJS.core.folder(o.path),o.base=o.origin+o.directory):(o.path=t,o.directory=EPUBJS.core.folder(t),o.base=o.directory),o.filename=t.replace(o.base,""),i=o.filename.lastIndexOf("."),-1!=i&&(o.extension=o.filename.slice(i+1)),o},EPUBJS.core.folder=function(t){var e=t.lastIndexOf("/");if(-1==e)var i="";return i=t.slice(0,e+1)},EPUBJS.core.queue=function(t){var e=[],i=t,n=function(t,i,n){return e.push({funcName:t,args:i,context:n}),e},o=function(){var t;e.length&&(t=e.shift(),i[t.funcName].apply(t.context||i,t.args))},r=function(){for(;e.length;)o()},s=function(){e=[]},a=function(){return e.length};return{enqueue:n,dequeue:o,flush:r,clear:s,length:a}},EPUBJS.core.isElement=function(t){return!(!t||1!=t.nodeType)},EPUBJS.core.uuid=function(){var t=(new Date).getTime(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?i:7&i|8).toString(16)});return e},EPUBJS.core.values=function(t){for(var e=-1,i=Object.keys(t),n=i.length,o=Array(n);++e<n;)o[e]=t[i[e]];return o},EPUBJS.core.resolveUrl=function(t,e){var i,n=[],o=[],r=EPUBJS.core.uri(t),s=EPUBJS.core.uri(e),a=r.directory,h=s.directory,u=[];return"/"===a[0]&&(a=a.substring(1)),"/"===h[h.length-1]&&(a=a.substring(0,a.length-1)),"/"===h[0]&&(h=h.substring(1)),"/"===h[h.length-1]&&(h=h.substring(0,h.length-1)),a&&(u=a.split("/")),i=h.split("/"),i.reverse().forEach(function(t){".."===t?u.pop():t===u[u.length-1]?(u.pop(),o.unshift(t)):o.unshift(t)}),n=[r.origin],u.length&&(n=n.concat(u)),o&&(n=n.concat(o)),n=n.concat(s.filename),n.join("/")},EPUBJS.core.documentHeight=function(){return Math.max(document.documentElement.clientHeight,document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight)},EPUBJS.core.isNumber=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},EPUBJS.core.prefixed=function(t){var e=["Webkit","Moz","O","ms"],i=t[0].toUpperCase()+t.slice(1),n=e.length;if("undefined"!=typeof document.body.style[t])return t;for(var o=0;n>o;o++)if("undefined"!=typeof document.body.style[e[o]+i])return e[o]+i;return t},EPUBJS.core.defaults=function(t){for(var e=1,i=arguments.length;i>e;e++){var n=arguments[e];for(var o in n)void 0===t[o]&&(t[o]=n[o])}return t},EPUBJS.core.extend=function(t){var e=[].slice.call(arguments,1);return e.forEach(function(e){e&&Object.getOwnPropertyNames(e).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(e,i))})}),t},EPUBJS.core.insert=function(t,e,i){var n=EPUBJS.core.locationOf(t,e,i);return e.splice(n,0,t),n},EPUBJS.core.locationOf=function(t,e,i,n,o){var r,s=n||0,a=o||e.length,h=parseInt(s+(a-s)/2);return i||(i=function(t,e){return t>e?1:e>t?-1:(t=e)?0:void 0}),0>=a-s?h:(r=i(e[h],t),a-s===1?r>0?h:h+1:0===r?h:-1===r?EPUBJS.core.locationOf(t,e,i,h,a):EPUBJS.core.locationOf(t,e,i,s,h))},EPUBJS.core.indexOfSorted=function(t,e,i,n,o){var r,s=n||0,a=o||e.length,h=parseInt(s+(a-s)/2);return i||(i=function(t,e){return t>e?1:e>t?-1:(t=e)?0:void 0}),0>=a-s?-1:(r=i(e[h],t),a-s===1?0===r?h:-1:0===r?h:-1===r?EPUBJS.core.indexOfSorted(t,e,i,h,a):EPUBJS.core.indexOfSorted(t,e,i,s,h))},EPUBJS.core.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,EPUBJS.core.bounds=function(t){var e=window.getComputedStyle(t),i=["width","paddingRight","paddingLeft","marginRight","marginLeft","borderRightWidth","borderLeftWidth"],n=["height","paddingTop","paddingBottom","marginTop","marginBottom","borderTopWidth","borderBottomWidth"],o=0,r=0;return i.forEach(function(t){o+=parseFloat(e[t])||0}),n.forEach(function(t){r+=parseFloat(e[t])||0}),{height:r,width:o}},EPUBJS.core.borders=function(t){var e=window.getComputedStyle(t),i=["paddingRight","paddingLeft","marginRight","marginLeft","borderRightWidth","borderLeftWidth"],n=["paddingTop","paddingBottom","marginTop","marginBottom","borderTopWidth","borderBottomWidth"],o=0,r=0;return i.forEach(function(t){o+=parseFloat(e[t])||0}),n.forEach(function(t){r+=parseFloat(e[t])||0}),{height:r,width:o}},EPUBJS.core.windowBounds=function(){var t=window.innerWidth,e=window.innerHeight;return{top:0,left:0,right:t,bottom:e,width:t,height:e}},EPUBJS.core.cleanStringForXpath=function(t){var e=t.match(/[^'"]+|['"]/g);return e=e.map(function(t){return"'"===t?'"\'"':'"'===t?"'\"'":"'"+t+"'"}),"concat('',"+e.join(",")+")"},EPUBJS.core.indexOfTextNode=function(t){for(var e,i=t.parentNode,n=i.childNodes,o=-1,r=0;r<n.length&&(e=n[r],e.nodeType===Node.TEXT_NODE&&o++,e!=t);r++);return o},EPUBJS.Queue=function(t){this._q=[],this.context=t,this.tick=EPUBJS.core.requestAnimationFrame,this.running=!1},EPUBJS.Queue.prototype.enqueue=function(){var t,e,i,n=[].shift.call(arguments),o=arguments;return"function"==typeof n?(t=new RSVP.defer,e=t.promise,i={task:n,args:o,deferred:t,promise:e}):i={promise:n},this._q.push(i),setTimeout(this.flush.bind(this),0),i.promise},EPUBJS.Queue.prototype.dequeue=function(){var t,e,i;return this._q.length?(t=this._q.shift(),(e=t.task)?(i=e.apply(this.context,t.args),i&&"function"==typeof i.then?i.then(function(){t.deferred.resolve.apply(this.context,arguments)}.bind(this)):(t.deferred.resolve.apply(this.context,i),t.promise)):t.promise?t.promise:void 0):(t=new RSVP.defer,t.deferred.resolve(),t.promise)},EPUBJS.Queue.prototype.dump=function(){for(;this._q.length;)this.dequeue()},EPUBJS.Queue.prototype.run=function(){!this.running&&this._q.length&&(this.running=!0,this.dequeue().then(function(){this.running=!1}.bind(this))),this.tick.call(window,this.run.bind(this))},EPUBJS.Queue.prototype.flush=function(){return this.running?this.running:this._q.length?(this.running=this.dequeue().then(function(){return this.running=void 0,this.flush()}.bind(this)),this.running):void 0},EPUBJS.Queue.prototype.clear=function(){this._q=[],this.running=!1},EPUBJS.Queue.prototype.length=function(){return this._q.length},EPUBJS.Task=function(t){return function(){var e=arguments||[];return new RSVP.Promise(function(i){var n=function(t){i(t)};e.push(n),t.apply(this,e)}.bind(this))}},EPUBJS.Hook=function(t){this.context=t||this,this.hooks=[]},EPUBJS.Hook.prototype.register=function(t){this.hooks.push(t)},EPUBJS.Hook.prototype.trigger=function(){var t=arguments,e=this.context,i=[];return this.hooks.forEach(function(n){var o=n.apply(e,t);o&&"function"==typeof o.then&&i.push(o)}),RSVP.all(i)},EPUBJS.Parser=function(){},EPUBJS.Parser.prototype.container=function(t){var e,i,n,o;return t?(e=t.querySelector("rootfile"))?(i=e.getAttribute("full-path"),n=EPUBJS.core.uri(i).directory,o=t.xmlEncoding,{packagePath:i,basePath:n,encoding:o}):(console.error("No RootFile Found"),void 0):(console.error("Container File Not Found"),void 0)},EPUBJS.Parser.prototype.identifier=function(t){var e;return t?(e=t.querySelector("metadata"),e?this.getElementText(e,"identifier"):(console.error("No Metadata Found"),void 0)):(console.error("Package File Not Found"),void 0)},EPUBJS.Parser.prototype.packageContents=function(t){var e,i,n,o,r,s,a,h,u,c=this;return t?(e=t.querySelector("metadata"))?(i=t.querySelector("manifest"))?(n=t.querySelector("spine"))?(o=c.manifest(i),r=c.findNavPath(i),s=c.findNcxPath(i),a=c.findCoverPath(i),h=Array.prototype.indexOf.call(n.parentNode.childNodes,n),u=c.spine(n,o),{metadata:c.metadata(e),spine:u,manifest:o,navPath:r,ncxPath:s,coverPath:a,spineNodeIndex:h}):(console.error("No Spine Found"),void 0):(console.error("No Manifest Found"),void 0):(console.error("No Metadata Found"),void 0):(console.error("Package File Not Found"),void 0)},EPUBJS.Parser.prototype.findNavPath=function(t){var e=t.querySelector("item[properties^='nav']");return e?e.getAttribute("href"):!1},EPUBJS.Parser.prototype.findNcxPath=function(t){var e=t.querySelector("item[media-type='application/x-dtbncx+xml']");return e?e.getAttribute("href"):!1},EPUBJS.Parser.prototype.findCoverPath=function(t){var e=t.querySelector("item[properties='cover-image']");return e?e.getAttribute("href"):!1},EPUBJS.Parser.prototype.metadata=function(t){var e={},i=this;return e.title=i.getElementText(t,"title"),e.creator=i.getElementText(t,"creator"),e.description=i.getElementText(t,"description"),e.pubdate=i.getElementText(t,"date"),e.publisher=i.getElementText(t,"publisher"),e.identifier=i.getElementText(t,"identifier"),e.language=i.getElementText(t,"language"),e.rights=i.getElementText(t,"rights"),e.modified_date=i.querySelectorText(t,"meta[property='dcterms:modified']"),e.layout=i.querySelectorText(t,"meta[property='rendition:layout']"),e.orientation=i.querySelectorText(t,"meta[property='rendition:orientation']"),e.spread=i.querySelectorText(t,"meta[property='rendition:spread']"),e},EPUBJS.Parser.prototype.getElementText=function(t,e){var i,n=t.getElementsByTagNameNS("http://purl.org/dc/elements/1.1/",e);return n&&0!==n.length?(i=n[0],i.childNodes.length?i.childNodes[0].nodeValue:""):""},EPUBJS.Parser.prototype.querySelectorText=function(t,e){var i=t.querySelector(e);return i&&i.childNodes.length?i.childNodes[0].nodeValue:""},EPUBJS.Parser.prototype.manifest=function(t){var e={},i=t.querySelectorAll("item"),n=Array.prototype.slice.call(i);return n.forEach(function(t){var i=t.getAttribute("id"),n=t.getAttribute("href")||"",o=t.getAttribute("media-type")||"",r=t.getAttribute("properties")||"";e[i]={href:n,type:o,properties:r.length?r.split(" "):[]}}),e},EPUBJS.Parser.prototype.spine=function(t){{var e=[],i=t.getElementsByTagName("itemref"),n=Array.prototype.slice.call(i);new EPUBJS.EpubCFI}return n.forEach(function(t,i){var n=t.getAttribute("idref"),o=t.getAttribute("properties")||"",r=o.length?o.split(" "):[],s={idref:n,linear:t.getAttribute("linear")||"",properties:r,index:i};e.push(s)}),e},EPUBJS.Parser.prototype.nav=function(t){function e(t){var e=[];return Array.prototype.slice.call(t.childNodes).forEach(function(t){"ol"==t.tagName&&Array.prototype.slice.call(t.childNodes).forEach(function(t){"li"==t.tagName&&e.push(t)})}),e}function i(t){var e=null;return Array.prototype.slice.call(t.childNodes).forEach(function(t){("a"==t.tagName||"span"==t.tagName)&&(e=t)}),e}function n(t){var o=[],r=e(t),s=Array.prototype.slice.call(r),a=s.length;return 0===a?!1:(s.forEach(function(e){var r=e.getAttribute("id")||!1,s=i(e),a=s.getAttribute("href")||"",h=s.textContent||"",u=a.split("#"),c=(u[0],n(e));o.push({id:r,href:a,label:h,subitems:c,parent:t?t.getAttribute("id"):null})}),o)}var o=t.querySelector('nav[*|type="toc"]');return o?n(o):[]},EPUBJS.Parser.prototype.ncx=function(t){function e(i){var n=[],o=t.evaluate("*[local-name()='navPoint']",i,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),r=o.snapshotLength;if(0===r)return[];for(var s=r-1;s>=0;s--){var a=o.snapshotItem(s),h=a.getAttribute("id")||!1,u=a.querySelector("content"),c=u.getAttribute("src"),l=a.querySelector("navLabel"),p=l.textContent?l.textContent:"",d=c.split("#"),f=(d[0],e(a));n.unshift({id:h,href:c,label:p,subitems:f,parent:i?i.getAttribute("id"):null})}return n}var i=t.querySelector("navMap");return i?e(i):[]},EPUBJS.EpubCFI=function(t){return t?this.parse(t):void 0},EPUBJS.EpubCFI.prototype.generateChapterComponent=function(t,e,i){var n=parseInt(e),o=t+1,r="/"+o+"/";return r+=2*(n+1),i&&(r+="["+i+"]"),r},EPUBJS.EpubCFI.prototype.generatePathComponent=function(t){var e=[];return t.forEach(function(t){var i="";i+=2*(t.index+1),t.id&&(i+="["+t.id+"]"),e.push(i)}),e.join("/")},EPUBJS.EpubCFI.prototype.generateCfiFromElement=function(t,e){var i=this.pathTo(t),n=this.generatePathComponent(i);return n.length?"epubcfi("+e+"!"+n+"/1:0)":"epubcfi("+e+"!/4/)"},EPUBJS.EpubCFI.prototype.pathTo=function(t){for(var e,i=[];t&&null!==t.parentNode&&9!=t.parentNode.nodeType;)e=t.parentNode.children,i.unshift({id:t.id,tagName:t.tagName,index:e?Array.prototype.indexOf.call(e,t):0}),t=t.parentNode;return i},EPUBJS.EpubCFI.prototype.getChapterComponent=function(t){var e=t.split("!");return e[0]},EPUBJS.EpubCFI.prototype.getPathComponent=function(t){var e=t.split("!"),i=e[1]?e[1].split(":"):"";return i[0]},EPUBJS.EpubCFI.prototype.getCharecterOffsetComponent=function(t){var e=t.split(":");return e[1]||""},EPUBJS.EpubCFI.prototype.parse=function(t){var e,i,n,o,r,s,a,h,u,c={},l=function(t){var e,i,n,o;return e="element",i=parseInt(t)/2-1,n=t.match(/\[(.*)\]/),n&&n[1]&&(o=n[1]),{type:e,index:i,id:o||!1}};return"string"!=typeof t?{spinePos:-1}:(c.str=t,0===t.indexOf("epubcfi(")&&")"===t[t.length-1]&&(t=t.slice(8,t.length-1)),i=this.getChapterComponent(t),n=this.getPathComponent(t)||"",o=this.getCharecterOffsetComponent(t),i?(e=i.split("/")[2]||"")?(c.spinePos=parseInt(e)/2-1||0,s=e.match(/\[(.*)\]/),c.spineId=s?s[1]:!1,-1!=n.indexOf(",")&&console.warn("CFI Ranges are not supported"),a=n.split("/"),h=a.pop(),c.steps=[],a.forEach(function(t){var e;t&&(e=l(t),c.steps.push(e))}),u=parseInt(h),isNaN(u)||(u%2===0?c.steps.push(l(h)):c.steps.push({type:"text",index:(u-1)/2})),r=o.match(/\[(.*)\]/),r&&r[1]?(c.characterOffset=parseInt(o.split("[")[0]),c.textLocationAssertion=r[1]):c.characterOffset=parseInt(o),c):{spinePos:-1}:{spinePos:-1})},EPUBJS.EpubCFI.prototype.addMarker=function(t,e,i){var n,o,r,s,a=e||document,h=i||this.createMarker(a);return"string"==typeof t&&(t=this.parse(t)),o=t.steps[t.steps.length-1],-1===t.spinePos?!1:(n=this.findParent(t,a))?(o&&"text"===o.type?(r=n.childNodes[o.index],t.characterOffset?(s=r.splitText(t.characterOffset),h.classList.add("EPUBJS-CFI-SPLIT"),n.insertBefore(h,s)):n.insertBefore(h,r)):n.insertBefore(h,n.firstChild),h):!1},EPUBJS.EpubCFI.prototype.createMarker=function(t){var e=t||document,i=e.createElement("span");return i.id="EPUBJS-CFI-MARKER:"+EPUBJS.core.uuid(),i.classList.add("EPUBJS-CFI-MARKER"),i},EPUBJS.EpubCFI.prototype.removeMarker=function(t,e){t.classList.contains("EPUBJS-CFI-SPLIT")?(nextSib=t.nextSibling,prevSib=t.previousSibling,nextSib&&prevSib&&3===nextSib.nodeType&&3===prevSib.nodeType&&(prevSib.textContent+=nextSib.textContent,t.parentNode.removeChild(nextSib)),t.parentNode.removeChild(t)):t.classList.contains("EPUBJS-CFI-MARKER")&&t.parentNode.removeChild(t)},EPUBJS.EpubCFI.prototype.findParent=function(t,e){var i,n,o,r=e||document,s=r.getElementsByTagName("html")[0],a=Array.prototype.slice.call(s.children);if("string"==typeof t&&(t=this.parse(t)),n=t.steps.slice(0),!n.length)return r.getElementsByTagName("body")[0];for(;n&&n.length>0;){if(i=n.shift(),"text"===i.type?(o=s.childNodes[i.index],s=o.parentNode||s):s=i.id?r.getElementById(i.id):a[i.index],"undefined"==typeof s)return console.error("No Element For",i,t.str),!1;a=Array.prototype.slice.call(s.children)}return s},EPUBJS.EpubCFI.prototype.compare=function(t,e){if("string"==typeof t&&(t=new EPUBJS.EpubCFI(t)),"string"==typeof e&&(e=new EPUBJS.EpubCFI(e)),t.spinePos>e.spinePos)return 1;if(t.spinePos<e.spinePos)return-1;for(var i=0;i<t.steps.length;i++){if(!e.steps[i])return 1;if(t.steps[i].index>e.steps[i].index)return 1;if(t.steps[i].index<e.steps[i].index)return-1}return t.steps.length<e.steps.length?-1:t.characterOffset>e.characterOffset?1:t.characterOffset<e.characterOffset?-1:0},EPUBJS.EpubCFI.prototype.generateCfiFromHref=function(t,e){var i,n,o=EPUBJS.core.uri(t),r=o.path,s=o.fragment,a=e.spineIndexByURL[r],h=new RSVP.defer,u=new EPUBJS.EpubCFI;return"undefined"!=typeof a&&(n=e.spine[a],i=e.loadXml(n.url),i.then(function(t){var e,i=t.getElementById(s);e=u.generateCfiFromElement(i,n.cfiBase),h.resolve(e)})),h.promise},EPUBJS.EpubCFI.prototype.generateCfiFromTextNode=function(t,e,i){var n=t.parentNode,o=this.pathTo(n),r=this.generatePathComponent(o),s=1+2*Array.prototype.indexOf.call(n.childNodes,t);return"epubcfi("+i+"!"+r+"/"+s+":"+(e||0)+")"},EPUBJS.EpubCFI.prototype.generateCfiFromRangeAnchor=function(t,e){var i=t.anchorNode,n=t.anchorOffset;return this.generateCfiFromTextNode(i,n,e)},EPUBJS.EpubCFI.prototype.generateCfiFromRange=function(t,e){var i,n,o,r,s,a,h,u,c,l,p,d;if(i=t.startContainer,3===i.nodeType)n=i.parentNode,a=1+2*EPUBJS.core.indexOfTextNode(i),o=this.pathTo(n);else{if(t.collapsed)return this.generateCfiFromElement(i,e);o=this.pathTo(i)}return r=this.generatePathComponent(o),s=t.startOffset,t.collapsed?"epubcfi("+e+"!"+r+"/"+a+":"+s+")":(h=t.endContainer,3===h.nodeType?(u=h.parentNode,d=1+2*EPUBJS.core.indexOfTextNode(h),c=this.pathTo(u)):c=this.pathTo(h),l=this.generatePathComponent(c),p=t.endOffset,"epubcfi("+e+"!"+r+"/"+a+":"+s+","+l+"/"+d+":"+p+")")},EPUBJS.EpubCFI.prototype.generateXpathFromSteps=function(t){var e=[".","*"];return t.forEach(function(t){var i=t.index+1;t.id?e.push("*[position()="+i+" and @id='"+t.id+"']"):"text"===t.type?e.push("text()["+i+"]"):e.push("*["+i+"]")}),e.join("/")},EPUBJS.EpubCFI.prototype.generateRangeFromCfi=function(t,e){var i,n,o,r,s=e||document,a=s.createRange();return"string"==typeof t&&(t=this.parse(t)),-1===t.spinePos?!1:(n=this.generateXpathFromSteps(t.steps),i=t.steps[t.steps.length-1],(o=s.evaluate(n,s,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue)?(o&&t.characterOffset>=0?(r=o.length,t.characterOffset<r?(a.setStart(o,t.characterOffset),a.setEnd(o,r)):(console.debug("offset greater than length:",t.characterOffset,r),a.setStart(o,r-1),a.setEnd(o,r))):o&&a.selectNode(o),a):null)},EPUBJS.EpubCFI.prototype.isCfiString=function(t){return"string"==typeof t&&0===t.indexOf("epubcfi(")?!0:!1},EPUBJS.Navigation=function(t,e){var i=this,n=new EPUBJS.Parser,o=e||EPUBJS.core.request;this.package=t,this.toc=[],this.tocByHref={},this.tocById={},t.navPath&&(this.navUrl=t.baseUrl+t.navPath,this.nav={},this.nav.load=function(){var t=new RSVP.defer,e=t.promise;return o(i.navUrl,"xml").then(function(e){i.toc=n.nav(e),i.loaded(i.toc),t.resolve(i.toc)}),e}),t.ncxPath&&(this.ncxUrl=t.baseUrl+t.ncxPath,this.ncx={},this.ncx.load=function(){var t=new RSVP.defer,e=t.promise;return o(i.ncxUrl,"xml").then(function(e){i.toc=n.ncx(e),i.loaded(i.toc),t.resolve(i.toc)}),e})},EPUBJS.Navigation.prototype.load=function(t){{var e,i;t||EPUBJS.core.request}return this.nav?e=this.nav.load():this.ncx?e=this.ncx.load():(i=new RSVP.defer,i.resolve([]),e=i.promise),e},EPUBJS.Navigation.prototype.loaded=function(t){for(var e,i=0;i<t.length;i++)e=t[i],this.tocByHref[e.href]=i,this.tocById[e.id]=i},EPUBJS.Navigation.prototype.get=function(t){var e;return t?(0===t.indexOf("#")?e=this.tocById[t.substring(1)]:t in this.tocByHref&&(e=this.tocByHref[t]),this.toc[e]):this.toc},EPUBJS.Section=function(t){this.idref=t.idref,this.linear=t.linear,this.properties=t.properties,this.index=t.index,this.href=t.href,this.url=t.url,this.next=t.next,this.prev=t.prev,this.epubcfi=new EPUBJS.EpubCFI,this.cfiBase=t.cfiBase,this.hooks={},this.hooks.replacements=new EPUBJS.Hook(this),this.hooks.replacements.register(this.replacements)},EPUBJS.Section.prototype.load=function(t){var e=t||this.request||EPUBJS.core.request,i=new RSVP.defer,n=i.promise;return this.contents?i.resolve(this.contents):e(this.url,"xml").then(function(t){EPUBJS.core.folder(this.url);return this.document=t,this.contents=t.documentElement,this.hooks.replacements.trigger(this.document)}.bind(this)).then(function(){i.resolve(this.contents)}.bind(this)).catch(function(t){i.reject(t)}),n},EPUBJS.Section.prototype.replacements=function(t){var e,i=new RSVP.defer,n=t.createElement("base");
return n.setAttribute("href",this.url),t&&(e=t.querySelector("head")),e?(e.insertBefore(n,e.firstChild),i.resolve()):i.reject(new Error("No head to insert into")),i.promise},EPUBJS.Section.prototype.beforeSectionLoad=function(){},EPUBJS.Section.prototype.render=function(t){var e=new RSVP.defer,i=e.promise;return this.load(t).then(function(t){var i=new XMLSerializer,n=i.serializeToString(t);e.resolve(n)}).catch(function(t){e.reject(t)}),i},EPUBJS.Section.prototype.find=function(){},EPUBJS.Section.prototype.reconcileLayoutSettings=function(t){var e={layout:t.layout,spread:t.spread,orientation:t.orientation};return this.properties.forEach(function(t){var i,n,o=t.replace("rendition:",""),r=o.indexOf("-");-1!=r&&(i=o.slice(0,r),n=o.slice(r+1),e[i]=n)}),e},EPUBJS.Section.prototype.cfiFromRange=function(t){return this.epubcfi.generateCfiFromRange(t,this.cfiBase)},EPUBJS.Spine=function(t){this.request=t,this.spineItems=[],this.spineByHref={},this.spineById={}},EPUBJS.Spine.prototype.load=function(t){this.items=t.spine,this.manifest=t.manifest,this.spineNodeIndex=t.spineNodeIndex,this.baseUrl=t.baseUrl||"",this.length=this.items.length,this.epubcfi=new EPUBJS.EpubCFI,this.items.forEach(function(t,e){var i,n=this.manifest[t.idref];t.cfiBase=this.epubcfi.generateChapterComponent(this.spineNodeIndex,t.index,t.idref),n&&(t.href=n.href,t.url=this.baseUrl+t.href,n.properties.length&&t.properties.push.apply(t.properties,n.properties)),t.prev=function(){return this.get(e-1)}.bind(this),t.next=function(){return this.get(e+1)}.bind(this),i=new EPUBJS.Section(t),this.append(i)}.bind(this))},EPUBJS.Spine.prototype.get=function(t){var e=0;return this.epubcfi.isCfiString(t)?(cfi=this.epubcfi.parse(t),e=cfi.spinePos):!t||"number"!=typeof t&&isNaN(t)!==!1?t&&0===t.indexOf("#")?e=this.spineById[t.substring(1)]:t&&(t=t.split("#")[0],e=this.spineByHref[t]):e=t,this.spineItems[e]||null},EPUBJS.Spine.prototype.append=function(t){var e=this.spineItems.length;return t.index=e,this.spineItems.push(t),this.spineByHref[t.href]=e,this.spineById[t.idref]=e,e},EPUBJS.Spine.prototype.prepend=function(t){this.spineItems.unshift(t);return this.spineByHref[t.href]=0,this.spineById[t.idref]=0,this.spineItems.forEach(function(t,e){t.index=e}),0},EPUBJS.Spine.prototype.insert=function(){},EPUBJS.Spine.prototype.remove=function(t){var e=this.spineItems.indexOf(t);return e>-1?(delete this.spineByHref[t.href],delete this.spineById[t.idref],this.spineItems.splice(e,1)):void 0},EPUBJS.replace={},EPUBJS.replace.links=function(t,e){for(var i=t.document.querySelectorAll("a[href]"),n=function(t){var i=t.getAttribute("href"),n=new EPUBJS.core.uri(i);n.protocol?t.setAttribute("target","_blank"):0===i.indexOf("#")||(t.onclick=function(){return e.display(i),!1})},o=0;o<i.length;o++)n(i[o])},EPUBJS.Book=function(t){this.opening=new RSVP.defer,this.opened=this.opening.promise,this.isOpen=!1,this.url=void 0,this.spine=new EPUBJS.Spine(this.request),this.loading={manifest:new RSVP.defer,spine:new RSVP.defer,metadata:new RSVP.defer,cover:new RSVP.defer,navigation:new RSVP.defer,pageList:new RSVP.defer},this.loaded={manifest:this.loading.manifest.promise,spine:this.loading.spine.promise,metadata:this.loading.metadata.promise,cover:this.loading.cover.promise,navigation:this.loading.navigation.promise,pageList:this.loading.pageList.promise},this.ready=RSVP.hash(this.loaded),this.isRendered=!1,this._q=EPUBJS.core.queue(this),this.request=this.requestMethod.bind(this),t&&this.open(t)},EPUBJS.Book.prototype.open=function(t){var e,i,n,o=new EPUBJS.Parser,r=this,s="META-INF/container.xml";return t?(e="object"==typeof t?t:EPUBJS.core.uri(t),"opf"===e.extension?(this.packageUrl=e.href,this.containerUrl="",e.origin?this.url=e.base:window?(n=EPUBJS.core.uri(window.location.href),this.url=EPUBJS.core.resolveUrl(n.base,e.directory)):this.url=e.directory,i=this.request(this.packageUrl)):"epub"===e.extension||"zip"===e.extension?(this.archived=!0,this.url=""):e.extension||(this.containerUrl=t+s,i=this.request(this.containerUrl).then(function(t){return o.container(t)}).then(function(e){var i=EPUBJS.core.uri(e.packagePath);return r.packageUrl=t+e.packagePath,r.encoding=e.encoding,i.origin?r.url=i.base:window?(n=EPUBJS.core.uri(window.location.href),r.url=EPUBJS.core.resolveUrl(n.base,t+i.directory)):r.url=i.directory,r.request(r.packageUrl)}).catch(function(t){console.error("Could not load book at: "+(this.packageUrl||this.containerPath)),r.trigger("book:loadFailed",this.packageUrl||this.containerPath),r.opening.reject(t)})),i.then(function(t){r.unpack(t),r.loading.manifest.resolve(r.package.manifest),r.loading.metadata.resolve(r.package.metadata),r.loading.spine.resolve(r.spine),r.loading.cover.resolve(r.cover),this.isOpen=!0,r.opening.resolve(r)}).catch(function(t){console.error(t.message,t.stack),r.opening.reject(t)}),this.opened):(this.opening.resolve(this),this.opened)},EPUBJS.Book.prototype.unpack=function(t){var e=this,i=new EPUBJS.Parser;e.package=i.packageContents(t),e.package.baseUrl=e.url,this.spine.load(e.package),e.navigation=new EPUBJS.Navigation(e.package,this.request),e.navigation.load().then(function(t){e.toc=t,e.loading.navigation.resolve(e.toc)}),e.cover=e.url+e.package.coverPath},EPUBJS.Book.prototype.section=function(t){return this.spine.get(t)},EPUBJS.Book.prototype.renderTo=function(t,e){var i=e&&e.method?e.method.charAt(0).toUpperCase()+e.method.substr(1):"Rendition";return this.rendition=new EPUBJS[i](this,e),this.rendition.attachTo(t),this.rendition},EPUBJS.Book.prototype.requestMethod=function(t){return this.archived?void 0:EPUBJS.core.request(t,"xml",this.requestCredentials,this.requestHeaders)},EPUBJS.Book.prototype.setRequestCredentials=function(t){this.requestCredentials=t},EPUBJS.Book.prototype.setRequestHeaders=function(t){this.requestHeaders=t},RSVP.EventTarget.mixin(EPUBJS.Book.prototype),RSVP.on("error",function(){}),RSVP.configure("instrument",!0),RSVP.on("rejected",function(t){console.error(t.detail.message,t.detail.stack)}),EPUBJS.View=function(t,e){this.settings=e||{},this.id="epubjs-view:"+EPUBJS.core.uuid(),this.section=t,this.index=t.index,this.element=document.createElement("div"),this.element.classList.add("epub-view"),this.element.style.height="0px",this.element.style.width="0px",this.element.style.overflow="hidden",this.added=!1,this.displayed=!1,this.rendered=!1,this.epubcfi=new EPUBJS.EpubCFI,this.element.style.display=this.settings.axis&&"horizontal"==this.settings.axis?"inline-block":"block"},EPUBJS.View.prototype.create=function(){return this.iframe?this.iframe:(this.iframe=document.createElement("iframe"),this.iframe.id=this.id,this.iframe.scrolling="no",this.iframe.style.overflow="hidden",this.iframe.seamless="seamless",this.iframe.style.border="none",this.resizing=!0,this.element.style.visibility="hidden",this.iframe.style.visibility="hidden",this.iframe.style.width="0",this.iframe.style.height="0",this._width=0,this._height=0,this.element.appendChild(this.iframe),this.added=!0,this.elementBounds=EPUBJS.core.bounds(this.element),this.supportsSrcdoc=!1,this.iframe)},EPUBJS.View.prototype.lock=function(t,e,i){var n,o=EPUBJS.core.borders(this.element);n=this.iframe?EPUBJS.core.borders(this.iframe):{width:0,height:0},"width"==t&&EPUBJS.core.isNumber(e)&&(this.lockedWidth=e-o.width-n.width,this.resize(this.lockedWidth,e)),"height"==t&&EPUBJS.core.isNumber(i)&&(this.lockedHeight=i-o.height-n.height,this.resize(e,this.lockedHeight)),"both"===t&&EPUBJS.core.isNumber(e)&&EPUBJS.core.isNumber(i)&&(this.lockedWidth=e-o.width-n.width,this.lockedHeight=i-o.height-n.height,this.resize(this.lockedWidth,this.lockedHeight)),this.displayed&&this.iframe&&(this.layout(),this.expand())},EPUBJS.View.prototype.expand=function(){var t,e,i=this.lockedWidth,n=this.lockedHeight;this.iframe&&!this._expanding&&(this._expanding=!0,n&&!i&&(t=this.textWidth(),t!=this._textWidth?(i=this.contentWidth(t),this._textWidth=t,this._contentWidth=i):i=this._contentWidth),i&&!n&&(e=this.textHeight(),e!=this._textHeight?(n=this.contentHeight(e),this._textHeight=e,this._contentHeight=n):n=this._contentHeight),(this._needsReframe||i!=this._width||n!=this._height)&&this.resize(i,n),this._expanding=!1)},EPUBJS.View.prototype.contentWidth=function(t){var e,i;return e=this.iframe.style.width,this.iframe.style.width=(t||0)+"px",i=this.document.body.scrollWidth,this.iframe.style.width=e,i},EPUBJS.View.prototype.contentHeight=function(t){var e,i;return e=this.iframe.style.height,this.iframe.style.height=(t||0)+"px",i=this.document.body.scrollHeight,this.iframe.style.height=e,i},EPUBJS.View.prototype.textWidth=function(){var t,e=this.document.createRange();return e.selectNodeContents(this.document.body),t=e.getBoundingClientRect().width},EPUBJS.View.prototype.textHeight=function(){var t,e=this.document.createRange();return e.selectNodeContents(this.document.body),t=e.getBoundingClientRect().height},EPUBJS.View.prototype.resize=function(t,e){this.iframe&&(EPUBJS.core.isNumber(t)&&(this.iframe.style.width=t+"px",this._width=t),EPUBJS.core.isNumber(e)&&(this.iframe.style.height=e+"px",this._height=e),this.iframeBounds=EPUBJS.core.bounds(this.iframe),this.reframe(this.iframeBounds.width,this.iframeBounds.height))},EPUBJS.View.prototype.reframe=function(t,e){return this.displayed?(EPUBJS.core.isNumber(t)&&(this.element.style.width=t+"px"),EPUBJS.core.isNumber(e)&&(this.element.style.height=e+"px"),this.prevBounds=this.elementBounds,this.elementBounds=EPUBJS.core.bounds(this.element),this.trigger("resized",{width:this.elementBounds.width,height:this.elementBounds.height,widthDelta:this.elementBounds.width-this.prevBounds.width,heightDelta:this.elementBounds.height-this.prevBounds.height}),void 0):(this._needsReframe=!0,void 0)},EPUBJS.View.prototype.resized=function(){},EPUBJS.View.prototype.render=function(t){return this.rendering=!0,this.section.render(t).then(function(t){return this.load(t)}.bind(this))},EPUBJS.View.prototype.load=function(t){var e=new RSVP.defer,i=e.promise;if(!this.iframe)return e.reject(new Error("No Iframe Available")),i;if(this.iframe.onload=function(){this.window=this.iframe.contentWindow,this.document=this.iframe.contentDocument,this.rendering=!1,e.resolve(this)}.bind(this),this.supportsSrcdoc)this.iframe.srcdoc=t;else{if(this.document=this.iframe.contentDocument,!this.document)return e.reject(new Error("No Document Available")),i;this.document.open(),this.document.write(t),this.document.close()}return i},EPUBJS.View.prototype.layout=function(t){this.iframe.style.display="inline-block",this.document.body.style.margin="0",t&&t(this),this.onLayout(this)},EPUBJS.View.prototype.onLayout=function(){},EPUBJS.View.prototype.listeners=function(){this.document.fonts&&"loading"===this.document.fonts.status&&(this.document.fonts.onloadingdone=function(){this.expand()}.bind(this)),this.section.properties.indexOf("scripted")>-1&&(this.observer=this.observe(this.document.body)),this.imageLoadListeners(),this.mediaQueryListeners(),this.resizeListenters()},EPUBJS.View.prototype.resizeListenters=function(){clearTimeout(this.expanding)},EPUBJS.View.prototype.mediaQueryListeners=function(){for(var t=this.document.styleSheets,e=function(t){t.matches&&!this._expanding&&setTimeout(this.expand.bind(this),1)}.bind(this),i=0;i<t.length;i+=1){var n=t[i].cssRules;if(!n)return;for(var o=0;o<n.length;o+=1)if(n[o].media){var r=this.window.matchMedia(n[o].media.mediaText);r.addListener(e)}}},EPUBJS.View.prototype.observe=function(t){var e=this,i=new MutationObserver(function(){e._expanding&&e.expand()}),n={attributes:!0,childList:!0,characterData:!0,subtree:!0};return i.observe(t,n),i},EPUBJS.View.prototype.imageLoadListeners=function(){for(var t,e=this.document.body.querySelectorAll("img"),i=0;i<e.length;i++)t=e[i],"undefined"!=typeof t.naturalWidth&&0===t.naturalWidth&&(t.onload=this.expand.bind(this))},EPUBJS.View.prototype.display=function(){var t=new RSVP.defer;return this.displayed=!0,this.layout(),this.listeners(),this.expand(),this.trigger("displayed",this),this.onDisplayed(this),t.resolve(this),t.promise},EPUBJS.View.prototype.show=function(){this.element.style.visibility="visible",this.iframe&&(this.iframe.style.visibility="visible"),this.trigger("shown",this)},EPUBJS.View.prototype.hide=function(){this.element.style.visibility="hidden",this.iframe.style.visibility="hidden",this.stopExpanding=!0,this.trigger("hidden",this)},EPUBJS.View.prototype.position=function(){return this.element.getBoundingClientRect()},EPUBJS.View.prototype.onDisplayed=function(){},EPUBJS.View.prototype.bounds=function(){return this.elementBounds||(this.elementBounds=EPUBJS.core.bounds(this.element)),this.elementBounds},EPUBJS.View.prototype.destroy=function(){this.observer&&this.observer.disconnect(),this.displayed&&(this.stopExpanding=!0,this.element.removeChild(this.iframe),this.displayed=!1,this.iframe=null,this._textWidth=null,this._textHeight=null,this._width=null,this._height=null)},EPUBJS.View.prototype.root=function(){return this.document?this.document.documentElement:null},EPUBJS.View.prototype.locationOf=function(t){var e=this.iframe.getBoundingClientRect(),i={left:0,top:0};return this.document?(this.epubcfi.isCfiString(t)?(cfi=this.epubcfi.parse(t),"undefined"==typeof document.evaluate?(marker=this.epubcfi.addMarker(cfi,this.document),marker&&(this.epubcfi.removeMarker(marker,this.document),i=marker.getBoundingClientRect())):(range=this.epubcfi.generateRangeFromCfi(cfi,this.document),range&&(i=range.getBoundingClientRect()))):"string"==typeof t&&t.indexOf("#")>-1&&(id=t.substring(t.indexOf("#")+1),el=this.document.getElementById(id),el&&(i=el.getBoundingClientRect())),{left:window.scrollX+e.left+i.left,top:window.scrollY+e.top+i.top}):void 0},EPUBJS.View.prototype.addCss=function(t){return new RSVP.Promise(function(e){var i,n=!1;return this.document?(i=this.document.createElement("link"),i.type="text/css",i.rel="stylesheet",i.href=t,i.onload=i.onreadystatechange=function(){n||this.readyState&&"complete"!=this.readyState||(n=!0,setTimeout(function(){e(!0)},1))},this.document.head.appendChild(i),void 0):(e(!1),void 0)}.bind(this))},EPUBJS.View.prototype.addStylesheetRules=function(t){var e,i;if(this.document){var e=this.document.createElement("style");this.document.head.appendChild(e),i=e.sheet;for(var n=0,o=t.length;o>n;n++){var r=1,s=t[n],a=t[n][0],h="";"[object Array]"===Object.prototype.toString.call(s[1][0])&&(s=s[1],r=0);for(var u=s.length;u>r;r++){var c=s[r];h+=c[0]+":"+c[1]+(c[2]?" !important":"")+";\n"}i.insertRule(a+"{"+h+"}",i.cssRules.length)}}},EPUBJS.View.prototype.addScript=function(t){return new RSVP.Promise(function(e){var i,n=!1;return this.document?(i=this.document.createElement("script"),i.type="text/javascript",i.async=!0,i.src=t,i.onload=i.onreadystatechange=function(){n||this.readyState&&"complete"!=this.readyState||(n=!0,setTimeout(function(){e(!0)},1))},this.document.head.appendChild(i),void 0):(e(!1),void 0)}.bind(this))},RSVP.EventTarget.mixin(EPUBJS.View.prototype),EPUBJS.Layout=EPUBJS.Layout||{},EPUBJS.Layout.Reflowable=function(){},EPUBJS.Layout.Reflowable.prototype.calculate=function(t,e,i,n){var o,r,s,a=n||1,h=Math.floor(t),u=h%2===0?h:h-1,c=Math.floor(u/8),l=i>=0?i:c%2===0?c:c-1;o=a>1?Math.floor((u-l)/a):u,r=o*a,s=(o+l)*a,this.columnAxis=EPUBJS.core.prefixed("columnAxis"),this.columnGap=EPUBJS.core.prefixed("columnGap"),this.columnWidth=EPUBJS.core.prefixed("columnWidth"),this.columnFill=EPUBJS.core.prefixed("columnFill"),this.width=u,this.height=e,this.spread=r,this.delta=s,this.column=o,this.gap=l,this.divisor=a},EPUBJS.Layout.Reflowable.prototype.format=function(t){var e=t.document.documentElement,i=t.document.body;e.style.overflow="hidden",e.style.width=this.width+"px",i.style.height=this.height+"px",i.style[this.columnAxis]="horizontal",i.style[this.columnFill]="auto",i.style[this.columnGap]=this.gap+"px",i.style[this.columnWidth]=this.column+"px",t.iframe.style.marginRight=this.gap+"px"},EPUBJS.Layout.Reflowable.prototype.count=function(t){var e=t.root().scrollWidth,i=Math.ceil(e/this.spread);return{spreads:i,pages:i*this.divisor}},EPUBJS.Layout.Fixed=function(){},EPUBJS.Layout.Fixed.prototype.calculate=function(){},EPUBJS.Layout.Fixed.prototype.format=function(t){var e,i,n=t.document.documentElement,o=documentElement.querySelector("[name=viewport");o&&o.hasAttribute("content")&&(content=o.getAttribute("content"),contents=content.split(","),contents[0]&&(e=contents[0].replace("width=","")),contents[1]&&(i=contents[1].replace("height=",""))),t.resize(e,i),n.style.overflow="auto"},EPUBJS.Layout.Fixed.prototype.count=function(){return{spreads:1,pages:1}},EPUBJS.Layout.Scroll=function(){},EPUBJS.Layout.Scroll.prototype.calculate=function(t){this.spread=t,this.column=t,this.gap=0},EPUBJS.Layout.Scroll.prototype.format=function(t){var e=t.document.documentElement;e.style.width="auto",e.style.height="auto"},EPUBJS.Layout.Scroll.prototype.count=function(){return{spreads:1,pages:1}},EPUBJS.Rendition=function(t,e){this.settings=EPUBJS.core.extend(this.settings||{},{infinite:!0,hidden:!1,width:!1,height:null,layoutOveride:null,axis:"vertical"}),EPUBJS.core.extend(this.settings,e),this.viewSettings={},this.book=t,this.views=[],this.hooks={},this.hooks.display=new EPUBJS.Hook(this),this.hooks.content=new EPUBJS.Hook(this),this.hooks.layout=new EPUBJS.Hook(this),this.hooks.render=new EPUBJS.Hook(this),this.hooks.show=new EPUBJS.Hook(this),this.hooks.content.register(EPUBJS.replace.links.bind(this)),this.epubcfi=new EPUBJS.EpubCFI,this.q=new EPUBJS.Queue(this),this.q.enqueue(this.book.opened),this.q.enqueue(this.parseLayoutProperties)},EPUBJS.Rendition.prototype.initialize=function(t){{var e,i=t||{},n=i.height,o=i.width;i.hidden||!1}return i.height&&EPUBJS.core.isNumber(i.height)&&(n=i.height+"px"),i.width&&EPUBJS.core.isNumber(i.width)&&(o=i.width+"px"),e=document.createElement("div"),e.id="epubjs-container:"+EPUBJS.core.uuid(),e.classList.add("epub-container"),e.style.fontSize="0",e.style.wordSpacing="0",e.style.lineHeight="0",e.style.verticalAlign="top","horizontal"===this.settings.axis&&(e.style.whiteSpace="nowrap"),o&&(e.style.width=o),n&&(e.style.height=n),e.style.overflow=this.settings.overflow,e},EPUBJS.Rendition.wrap=function(t){var e=document.createElement("div");return e.style.visibility="hidden",e.style.overflow="hidden",e.style.width="0",e.style.height="0",e.appendChild(t),e},EPUBJS.Rendition.prototype.attachTo=function(t){return this.container=this.initialize({width:this.settings.width,height:this.settings.height}),EPUBJS.core.isElement(t)?this.element=t:"string"==typeof t&&(this.element=document.getElementById(t)),this.element?(this.settings.hidden?(this.wrapper=this.wrap(this.container),this.element.appendChild(this.wrapper)):this.element.appendChild(this.container),this.attachListeners(),this.stageSize(),this.applyLayoutMethod(),this.trigger("attached"),void 0):(console.error("Not an Element"),void 0)},EPUBJS.Rendition.prototype.attachListeners=function(){EPUBJS.core.isNumber(this.settings.width)&&EPUBJS.core.isNumber(this.settings.height)||window.addEventListener("resize",this.onResized.bind(this),!1)},EPUBJS.Rendition.prototype.bounds=function(){return this.container.getBoundingClientRect()},EPUBJS.Rendition.prototype.display=function(t){return this.q.enqueue(this._display,t)},EPUBJS.Rendition.prototype._display=function(t){var e,i,n,o,r,s=new RSVP.defer,a=s.promise,h=this.epubcfi.isCfiString(t);return(e=this.book.spine.get(t))?(r=this.find(e),r?(n=i.locationOf(t),this.q.enqueue(this.moveTo,n),this.q.enqueue(this.check)):(this.hide(),i=new EPUBJS.View(e,this.viewSettings),this.fill(i).then(function(){"string"==typeof t&&t.indexOf("#")>-1&&(o=t.substring(t.indexOf("#")+1)),(h||o)&&(n=i.locationOf(t),this.q.enqueue(this.moveTo,n)),"function"==typeof this.check&&this.q.enqueue(this.check),this.q.enqueue(this.show)}.bind(this))),this.hooks.display.trigger(i).then(function(){this.trigger("displayed",e),s.resolve(this)}.bind(this)),a):(s.reject(new Error("No Section Found")),a)},EPUBJS.Rendition.prototype.moveTo=function(t){this.scrollBy(t.left,t.top)},EPUBJS.Rendition.prototype.render=function(t,e){return t.create(),t.onLayout=this.layout.format.bind(this.layout),this.resizeView(t),t.render(this.book.request).then(function(){return this.hooks.content.trigger(t,this)}.bind(this)).then(function(){return this.hooks.layout.trigger(t,this)}.bind(this)).then(function(){return t.display()}.bind(this)).then(function(){return this.hooks.render.trigger(t,this)}.bind(this)).then(function(){e!==!1&&this.hidden===!1&&this.q.enqueue(function(t){t.show()},t),this.trigger("rendered",t.section)}.bind(this)).catch(function(t){this.trigger("loaderror",t)}.bind(this))},EPUBJS.Rendition.prototype.afterDisplayed=function(t){this.trigger("added",t.section)},EPUBJS.Rendition.prototype.fill=function(t){return this.views.length&&this.clear(),this.views.push(t),this.container.appendChild(t.element),t.onDisplayed=this.afterDisplayed.bind(this),this.render(t)},EPUBJS.Rendition.prototype.clear=function(){this.views.forEach(function(t){this._remove(t)}.bind(this)),this.views=[]},EPUBJS.Rendition.prototype.remove=function(t){var e=this.views.indexOf(t);e>-1&&this.views.splice(e,1),this._remove(t)},EPUBJS.Rendition.prototype._remove=function(t){t.off("resized"),t.displayed&&t.destroy(),this.container.removeChild(t.element),t=null},EPUBJS.Rendition.prototype.resizeView=function(t){"pre-paginated"===this.globalLayoutProperties.layout?t.lock("both",this.stage.width,this.stage.height):t.lock("width",this.stage.width,this.stage.height)},EPUBJS.Rendition.prototype.stageSize=function(t,e){var i,n=t||this.settings.width,o=e||this.settings.height;return n===!1&&(i=this.element.getBoundingClientRect(),i.width&&(n=i.width,this.container.style.width=i.width+"px")),o===!1&&(i=i||this.element.getBoundingClientRect(),i.height&&(o=i.height,this.container.style.height=i.height+"px")),n&&!EPUBJS.core.isNumber(n)&&(i=this.container.getBoundingClientRect(),n=i.width),o&&!EPUBJS.core.isNumber(o)&&(i=i||this.container.getBoundingClientRect(),o=i.height),this.containerStyles=window.getComputedStyle(this.container),this.containerPadding={left:parseFloat(this.containerStyles["padding-left"])||0,right:parseFloat(this.containerStyles["padding-right"])||0,top:parseFloat(this.containerStyles["padding-top"])||0,bottom:parseFloat(this.containerStyles["padding-bottom"])||0},this.stage={width:n-this.containerPadding.left-this.containerPadding.right,height:o-this.containerPadding.top-this.containerPadding.bottom},this.stage},EPUBJS.Rendition.prototype.applyLayoutMethod=function(){this.layout=new EPUBJS.Layout.Scroll,this.updateLayout(),this.map=new EPUBJS.Map(this.layout)},EPUBJS.Rendition.prototype.updateLayout=function(){this.layout.calculate(this.stage.width,this.stage.height)},EPUBJS.Rendition.prototype.resize=function(t,e){this.stageSize(t,e),this.updateLayout(),this.views.forEach(this.resizeView.bind(this)),this.trigger("resized",{width:this.stage.width,height:this.stage.height})},EPUBJS.Rendition.prototype.onResized=function(){this.resize()},EPUBJS.Rendition.prototype.createView=function(t){return new EPUBJS.View(t,this.viewSettings)},EPUBJS.Rendition.prototype.next=function(){return this.q.enqueue(function(){var t,e;return this.views.length?(t=this.views[0].section.next(),t?(e=this.createView(t),this.append(e)):void 0):void 0})},EPUBJS.Rendition.prototype.prev=function(){return this.q.enqueue(function(){var t,e;return this.views.length?(t=this.views[0].section.prev(),t?(e=this.createView(t),this.append(e)):void 0):void 0})},EPUBJS.Rendition.prototype.parseLayoutProperties=function(t){var e=t||this.book.package.metadata,i=this.layoutOveride&&this.layoutOveride.layout||e.layout||"reflowable",n=this.layoutOveride&&this.layoutOveride.spread||e.spread||"auto",o=this.layoutOveride&&this.layoutOveride.orientation||e.orientation||"auto";return this.globalLayoutProperties={layout:i,spread:n,orientation:o},this.globalLayoutProperties},EPUBJS.Rendition.prototype.current=function(){var t=this.visible();return t.length?t[t.length-1]:null},EPUBJS.Rendition.prototype.isVisible=function(t,e,i,n){var o=t.position(),r=n||this.container.getBoundingClientRect();return"horizontal"===this.settings.axis&&o.right>r.left-e&&!(o.left>=r.right+i)?!0:"vertical"===this.settings.axis&&o.bottom>r.top-e&&!(o.top>=r.bottom+i)?!0:!1},EPUBJS.Rendition.prototype.visible=function(){for(var t,e,i=this.bounds(),n=[],o=0;o<this.views.length;o++)e=this.views[o],t=this.isVisible(e,0,0,i),t===!0&&n.push(e);return n},EPUBJS.Rendition.prototype.find=function(t){for(var e,i=0;i<this.views.length;i++)if(e=this.views[i],e.displayed&&e.section.index==t.index)return e},EPUBJS.Rendition.prototype.bounds=function(){var t;return t=this.settings.height?this.container.getBoundingClientRect():EPUBJS.core.windowBounds()},EPUBJS.Rendition.prototype.displayed=function(){for(var t,e=[],i=0;i<this.views.length;i++)t=this.views[i],t.displayed&&e.push(t);return e},EPUBJS.Rendition.prototype.show=function(){for(var t,e=0;e<this.views.length;e++)t=this.views[e],t.displayed&&t.show();this.hidden=!1},EPUBJS.Rendition.prototype.hide=function(){for(var t,e=0;e<this.views.length;e++)t=this.views[e],t.displayed&&t.hide();this.hidden=!0},EPUBJS.Rendition.prototype.destroy=function(){this.q.clear(),this.clear(),clearTimeout(this.trimTimeout),this.settings.hidden?this.element.removeChild(this.wrapper):this.element.removeChild(this.container)},EPUBJS.Rendition.prototype.reportLocation=function(){return this.q.enqueue(function(){this.location=this.currentLocation(),this.trigger("locationChanged",this.location)}.bind(this))},EPUBJS.Rendition.prototype.currentLocation=function(){var t;return this.views.length?(t=this.views[0],this.map.page(t)):void 0},EPUBJS.Rendition.prototype.scrollBy=function(t,e,i){i&&(this.ignore=!0),this.settings.height?(t&&(this.container.scrollLeft+=t),e&&(this.container.scrollTop+=e)):window.scrollBy(t,e),this.scrolled=!0},EPUBJS.Rendition.prototype.scrollTo=function(t,e,i){i&&(this.ignore=!0),this.settings.height?(this.container.scrollLeft=t,this.container.scrollTop=e):window.scrollTo(t,e),this.scrolled=!0},RSVP.EventTarget.mixin(EPUBJS.Rendition.prototype),EPUBJS.Continuous=function(t,e){EPUBJS.Rendition.apply(this,arguments),this.settings=EPUBJS.core.extend(this.settings||{},{infinite:!0,overflow:"auto",axis:"vertical",offset:500,offsetDelta:250}),EPUBJS.core.extend(this.settings,e),this.settings.hidden&&(this.wrapper=this.wrap(this.container))},EPUBJS.Continuous.prototype=Object.create(EPUBJS.Rendition.prototype),EPUBJS.Continuous.prototype.constructor=EPUBJS.Continuous,EPUBJS.Continuous.prototype.attachListeners=function(){EPUBJS.core.isNumber(this.settings.width)&&EPUBJS.core.isNumber(this.settings.height)||window.addEventListener("resize",this.onResized.bind(this),!1),this.settings.infinite&&this.start()},EPUBJS.Continuous.prototype.parseTarget=function(t){this.epubcfi.isCfiString(t)?(cfi=this.epubcfi.parse(t),spinePos=cfi.spinePos,section=this.book.spine.get(spinePos)):section=this.book.spine.get(t)},EPUBJS.Continuous.prototype.moveTo=function(t){return this.check(t.left+this.settings.offset,t.top+this.settings.offset).then(function(){"vertical"===this.settings.axis?this.scrollBy(0,t.top):this.scrollBy(t.left,0)}.bind(this))},EPUBJS.Continuous.prototype.afterDisplayed=function(t){var e,i,n=t.section.next(),o=t.section.prev(),r=this.views.indexOf(t);r+1===this.views.length&&n&&(i=new EPUBJS.View(n,this.viewSettings),this.q.enqueue(this.append,i)),0===r&&o&&(e=new EPUBJS.View(o,this.viewSettings),this.q.enqueue(this.prepend,e)),this.trigger("added",t.section)},EPUBJS.Continuous.prototype.removeShownListeners=function(t){t.onDisplayed=function(){}},EPUBJS.Continuous.prototype.append=function(t){return this.views.push(t),this.container.appendChild(t.element),t.onDisplayed=this.afterDisplayed.bind(this),this.check()},EPUBJS.Continuous.prototype.prepend=function(t){return this.views.unshift(t),this.container.insertBefore(t.element,this.container.firstChild),t.onDisplayed=this.afterDisplayed.bind(this),t.on("resized",this.counter.bind(this)),this.check()},EPUBJS.Continuous.prototype.counter=function(t){"vertical"===this.settings.axis?this.scrollBy(0,t.heightDelta,!0):this.scrollBy(t.widthDelta,0,!0)},EPUBJS.Continuous.prototype.insert=function(t,e){return this.views.splice(e,0,t),e<this.cotainer.children.length?this.container.insertBefore(t.element,this.container.children[e]):this.container.appendChild(t.element),this.check()},EPUBJS.Continuous.prototype.first=function(){return this.views[0]},EPUBJS.Continuous.prototype.last=function(){return this.views[this.views.length-1]},EPUBJS.Continuous.prototype.each=function(t){return this.views.forEach(t)},EPUBJS.Continuous.prototype.check=function(t){var e=new RSVP.defer,i=this.bounds(),n=[],o=t||this.settings.offset;return this.views.forEach(function(t){var e=this.isVisible(t,o,o,i);e?t.displayed||t.rendering||n.push(this.render(t)):t.displayed&&(this.q.enqueue(t.destroy.bind(t)),clearTimeout(this.trimTimeout),this.trimTimeout=setTimeout(function(){this.q.enqueue(this.trim)}.bind(this),250))}.bind(this)),n.length?RSVP.all(n).then(function(){this.q.enqueue(this.check)}.bind(this)):(e.resolve(),e.promise)},EPUBJS.Continuous.prototype.trim=function(){for(var t=new RSVP.defer,e=this.displayed(),i=e[0],n=e[e.length-1],o=this.views.indexOf(i),r=this.views.indexOf(n),s=this.views.slice(0,o),a=this.views.slice(r+1),h=0;h<s.length-1;h++)this.erase(s[h],s);for(var u=1;u<a.length;u++)this.erase(a[u]);return t.resolve(),t.promise},EPUBJS.Continuous.prototype.erase=function(t,e){var i,n;this.settings.height?(i=this.container.scrollTop,n=this.container.scrollLeft):(i=window.scrollY,n=window.scrollX);var o=t.bounds();this.remove(t),e&&("vertical"===this.settings.axis?this.scrollTo(0,i-o.height,!0):this.scrollTo(n-o.width,0,!0))},EPUBJS.Continuous.prototype.checkCurrent=function(){var t,e,i=this.container.getBoundingClientRect(),n=this.views.length-1;if(!this.rendering)if("horizontal"===this.settings.axis);else for(var o=n;o>=0;o--)if(t=this.views[o],e=t.bounds().top,e<i.bottom){if(this.current==t.section)break;this.current=t.section,this.trigger("current",this.current);break}},EPUBJS.Continuous.prototype.start=function(){var t;this.tick=EPUBJS.core.requestAnimationFrame,this.settings.height?(this.prevScrollTop=this.container.scrollTop,this.prevScrollLeft=this.container.scrollLeft):(this.prevScrollTop=window.scrollY,this.prevScrollLeft=window.scrollX),this.scrollDeltaVert=0,this.scrollDeltaHorz=0,t=this.settings.height?this.container:window,window.addEventListener("scroll",function(){this.ignore?this.ignore=!1:this.scrolled=!0}.bind(this)),window.addEventListener("unload",function(){this.ignore=!0,this.destroy()}.bind(this)),this.tick.call(window,this.onScroll.bind(this)),this.scrolled=!1},EPUBJS.Continuous.prototype.onScroll=function(){this.scrolled&&(this.settings.height?(scrollTop=this.container.scrollTop,scrollLeft=this.container.scrollLeft):(scrollTop=window.scrollY,scrollLeft=window.scrollX),this.ignore?this.ignore=!1:(0===this.scrollDeltaVert&&0===this.scrollDeltaHorz||this.scrollDeltaVert>this.settings.offsetDelta||this.scrollDeltaHorz>this.settings.offsetDelta)&&(this.q.enqueue(this.check),this.scrollDeltaVert=0,this.scrollDeltaHorz=0),this.scrollDeltaVert+=Math.abs(scrollTop-this.prevScrollTop),this.scrollDeltaHorz+=Math.abs(scrollLeft-this.prevScrollLeft),this.settings.height?(this.prevScrollTop=this.container.scrollTop,this.prevScrollLeft=this.container.scrollLeft):(this.prevScrollTop=window.scrollY,this.prevScrollLeft=window.scrollX),clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(function(){this.scrollDeltaVert=0,this.scrollDeltaHorz=0}.bind(this),150),this.scrolled=!1),this.tick.call(window,this.onScroll.bind(this))},EPUBJS.Continuous.prototype.resizeView=function(t){"horizontal"===this.settings.axis?t.lock("height",this.stage.width,this.stage.height):t.lock("width",this.stage.width,this.stage.height)
},EPUBJS.Continuous.prototype.currentLocation=function(){{var t,e,i=this.visible();this.container.getBoundingClientRect()}return 1===i.length?this.map.page(i[0]):i.length>1?(t=this.map.page(i[0]),e=this.map.page(i[i.length-1]),{start:t.start,end:e.end}):void 0},EPUBJS.Paginate=function(t,e){EPUBJS.Continuous.apply(this,arguments),this.settings=EPUBJS.core.extend(this.settings||{},{width:600,height:400,axis:"horizontal",forceSingle:!1,minSpreadWidth:800,gap:"auto",overflow:"hidden",infinite:!1}),EPUBJS.core.extend(this.settings,e),this.isForcedSingle=this.settings.forceSingle,this.viewSettings={axis:this.settings.axis},this.start()},EPUBJS.Paginate.prototype=Object.create(EPUBJS.Continuous.prototype),EPUBJS.Paginate.prototype.constructor=EPUBJS.Paginate,EPUBJS.Paginate.prototype.determineSpreads=function(t){return this.isForcedSingle||!t||this.bounds().width<t?1:2},EPUBJS.Paginate.prototype.forceSingle=function(t){this.isForcedSingle=t===!1?!1:!0,this.applyLayoutMethod()},EPUBJS.Paginate.prototype.start=function(){this.on("displayed",this.reportLocation.bind(this)),this.hooks.content.register(this.adjustImages.bind(this)),this.currentPage=0,window.addEventListener("unload",function(){this.ignore=!0,this.destroy()}.bind(this))},EPUBJS.Paginate.prototype.applyLayoutMethod=function(){this.layout=new EPUBJS.Layout.Reflowable,this.updateLayout(),this.map=new EPUBJS.Map(this.layout)},EPUBJS.Paginate.prototype.updateLayout=function(){this.spreads=this.determineSpreads(this.settings.minSpreadWidth),this.layout.calculate(this.stage.width,this.stage.height,this.settings.gap,this.spreads),this.settings.offset=this.layout.delta},EPUBJS.Paginate.prototype.moveTo=function(t){var e=Math.floor(t.left/this.layout.delta)*this.layout.delta;return this.check(0,e+this.settings.offset).then(function(){this.scrollBy(e,0)}.bind(this))},EPUBJS.Paginate.prototype.page=function(){},EPUBJS.Paginate.prototype.next=function(){return this.q.enqueue(function(){return this.scrollBy(this.layout.delta,0),this.reportLocation(),this.check()})},EPUBJS.Paginate.prototype.prev=function(){return this.q.enqueue(function(){return this.scrollBy(-this.layout.delta,0),this.reportLocation(),this.check()})},EPUBJS.Paginate.prototype.reportLocation=function(){return this.q.enqueue(function(){this.location=this.currentLocation(),this.trigger("locationChanged",this.location)}.bind(this))},EPUBJS.Paginate.prototype.currentLocation=function(){var t,e,i,n,o,r,s=this.visible(),a=this.container.getBoundingClientRect();return 1===s.length?(t=a.left-s[0].position().left,i=t+this.layout.spread,this.map.page(s[0],t,i)):s.length>1?(t=a.left-s[0].position().left,i=t+this.layout.column,e=a.left+this.layout.spread-s[s.length-1].position().left,n=e+this.layout.column,o=this.map.page(s[0],t,i),r=this.map.page(s[s.length-1],e,n),{start:o.start,end:r.end}):void 0},EPUBJS.Paginate.prototype.resize=function(t,e){this.q.clear(),this.stageSize(t,e),this.updateLayout(),this.display(this.location.start),this.trigger("resized",{width:this.stage.width,height:this.stage.height})},EPUBJS.Paginate.prototype.onResized=function(){this.clear(),clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(function(){this.resize()}.bind(this),150)},EPUBJS.Paginate.prototype.adjustImages=function(t){return t.addStylesheetRules([["img",["max-width",this.layout.spread+"px"],["max-height",this.layout.height+"px"]]]),new RSVP.Promise(function(t){setTimeout(function(){t()},1)})},EPUBJS.Map=function(t){this.layout=t},EPUBJS.Map.prototype.section=function(t){var e=this.findRanges(t),i=this.rangeListToCfiList(t,e);return i},EPUBJS.Map.prototype.page=function(t,e,i){var n=t.document.body;return this.rangePairToCfiPair(t.section,{start:this.findStart(n,e,i),end:this.findEnd(n,e,i)})},EPUBJS.Map.prototype.walk=function(t,e){for(var i,n,o=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:function(t){return t.data.trim().length>0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}},!1);(i=o.nextNode())&&!(n=e(i)););return n},EPUBJS.Map.prototype.findRanges=function(t){for(var e,i,n=[],o=this.layout.count(t),r=this.layout.column,s=this.layout.gap,a=0;a<o.pages;a++)e=(r+s)*a,i=r*(a+1)+s*a,n.push({start:this.findStart(t.document.body,e,i),end:this.findEnd(t.document.body,e,i)});return n},EPUBJS.Map.prototype.findStart=function(t,e,i){for(var n,o,r=[t],s=t;r.length;)if(n=r.shift(),o=this.walk(n,function(t){var n,o,a,h;return t.nodeType==Node.TEXT_NODE?(h=document.createRange(),h.selectNodeContents(t),a=h.getBoundingClientRect()):a=t.getBoundingClientRect(),n=a.left,o=a.right,n>=e&&i>=n?t:o>e?t:(s=t,r.push(t),void 0)}))return this.findTextStartRange(o,e,i);return this.findTextStartRange(s,e,i)},EPUBJS.Map.prototype.findEnd=function(t,e,i){for(var n,o,r=[t],s=t;r.length;)if(n=r.shift(),o=this.walk(n,function(t){var e,n,o,a;return t.nodeType==Node.TEXT_NODE?(a=document.createRange(),a.selectNodeContents(t),o=a.getBoundingClientRect()):o=t.getBoundingClientRect(),e=o.left,n=o.right,e>i&&s?s:n>i?t:(s=t,r.push(t),void 0)}))return this.findTextEndRange(o,e,i);return this.findTextEndRange(s,e,i)},EPUBJS.Map.prototype.findTextStartRange=function(t,e){for(var i,n,o,r=this.splitTextNodeIntoRanges(t),s=0;s<r.length;s++){if(n=r[s],o=n.getBoundingClientRect(),o.left>=e)return n;i=n}return r[0]},EPUBJS.Map.prototype.findTextEndRange=function(t,e,i){for(var n,o,r,s=this.splitTextNodeIntoRanges(t),a=0;a<s.length;a++){if(o=s[a],r=o.getBoundingClientRect(),r.left>i&&n)return n;if(r.right>i)return o;n=o}return s[s.length-1]},EPUBJS.Map.prototype.splitTextNodeIntoRanges=function(t,e){var i,n=[],o=t.textContent||"",r=o.trim(),s=t.ownerDocument,a=e||" ";if(pos=r.indexOf(a),-1===pos||t.nodeType!=Node.TEXT_NODE)return i=s.createRange(),i.selectNodeContents(t),[i];for(i=s.createRange(),i.setStart(t,0),i.setEnd(t,pos),n.push(i),i=!1;-1!=pos;)pos=r.indexOf(a,pos+1),pos>0&&(i&&(i.setEnd(t,pos),n.push(i)),i=s.createRange(),i.setStart(t,pos+1));return i&&(i.setEnd(t,r.length),n.push(i)),n},EPUBJS.Map.prototype.rangePairToCfiPair=function(t,e){var i=e.start,n=e.end;return i.collapse(!0),n.collapse(!0),startCfi=t.cfiFromRange(i),endCfi=t.cfiFromRange(n),{start:startCfi,end:endCfi}},EPUBJS.Map.prototype.rangeListToCfiList=function(t,e){for(var i,n=[],o=0;o<e.length;o++)i=this.rangePairToCfiPair(t.section,e[o]),n.push(i);return n};